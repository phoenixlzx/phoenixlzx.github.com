<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    
    <title>归档：2014/5 | Phoenix&#39;s island</title>
    <meta name="author" content="Phoenix Nemo">
    
    <meta name="description" content="Phoenix&#39;s Blog">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <meta property="og:site_name" content="Phoenix&#39;s island"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link href="/favicon.png" rel="icon">
    <link rel="alternate" href="/atom.xml" title="Phoenix&#39;s island" type="application/atom+xml">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.css"/>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Phoenix&#39;s island</a></h1>
  <h2><a href="/">Sun will shine on the horizon.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/links">Links</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">2014/5</h2>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-23T20:52:59.000Z"><a href="/2014/05/24/iptables-rate-limiting-rules-to-block-dns-amplification-attack/">2014-05-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/24/iptables-rate-limiting-rules-to-block-dns-amplification-attack/">使用 iptables 过滤 DNS 放大攻击</a></h1>
  

    </header>
    <div class="entry">
      
        <p>昨晚开始我们的 DNS 日志中出现大量的针对 <code>wradish.com</code> 的<code>ANY</code>记录请求，导致大量正常解析请求超时。今天上午到中午时分再次出现流量更大、针对 <code>ping.zong.co.ua</code> 的<code>ANY</code>记录请求，导致整个 DNS 服务瘫痪，完全无法响应正常解析请求。</p>
<p>检查后发现 <code>wradish.com</code> 早已因多次 DNS 放大攻击而被列入开放 DNS 服务器黑名单，网络上也有大量的针对该域名攻击请求包的过滤方法。<code>ping.zong.co.ua</code> 却完全没有任何搜索记录。</p>
<p>DNS 放大攻击 (DNS Amplification Attack) 即通过向多台 DNS 开放服务器发送无意义的 recursive 解析请求，从而使得根域名服务器遭到超大流量的解析请求包，无暇顾及正常的解析请求，由此实现分布式拒绝服务攻击 (Distributed Denial of Service)。我们的 DNS 服务器在这里既是攻击者，也是受害者。</p>
<p>DNSMasq 默认允许 recursive 请求，且似乎本身就没有设计为开放 DNS 服务，所以貌似也没有办法禁用掉 recursive 请求。因此我们使用 <a href="http://blog.dataforce.org.uk/2013/08/limiting-the-effectiveness-of-dns-amplification/" target="_blank" rel="external">iptables 规则 </a> 来过滤掉这些请求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Create a chain to store block rules in</span></div><div class="line">iptables -N BADDNS </div><div class="line"></div><div class="line"><span class="comment"># Match all "IN ANY" DNS Queries, and run them past the BADDNS chain.</span></div><div class="line">iptables -A INPUT -p udp --dport <span class="number">53</span> -m string --hex-string <span class="string">"|00 00 ff 00 01|"</span> --to <span class="number">255</span> --algo bm -m comment --comment <span class="string">"IN ANY?"</span> -j BADDNS</div><div class="line">iptables -A FORWARD -p udp --dport <span class="number">53</span> -m string --hex-string <span class="string">"|00 00 ff 00 01|"</span> --to <span class="number">255</span> --algo bm -m comment --comment <span class="string">"IN ANY?"</span> -j BADDNS</div><div class="line"></div><div class="line"><span class="comment"># Block domains that are being used for DNS Amplification...</span></div><div class="line">iptables -A BADDNS -m string --hex-string <span class="string">"|04 72 69 70 65 03 6e 65 74 00|"</span> --algo bm -j DROP --to <span class="number">255</span> -m comment --comment <span class="string">"ripe.net"</span></div><div class="line">iptables -A BADDNS -m string --hex-string <span class="string">"|03 69 73 63 03 6f 72 67 00|"</span> --algo bm -j DROP --to <span class="number">255</span> -m comment --comment <span class="string">"isc.org"</span></div><div class="line">iptables -A BADDNS -m string --hex-string <span class="string">"|04 73 65 6d 61 02 63 7a 00|"</span> --algo bm -j DROP --to <span class="number">255</span> -m comment --comment <span class="string">"sema.cz"</span></div><div class="line">iptables -A BADDNS -m string --hex-string <span class="string">"|09 68 69 7a 62 75 6c 6c 61 68 02 6d 65 00|"</span> --algo bm -j DROP --to <span class="number">255</span> -m comment --comment <span class="string">"hizbullah.me"</span></div><div class="line"></div><div class="line"><span class="comment"># Rate limit the rest.</span></div><div class="line">iptables -A BADDNS -m recent --set --name DNSQF --rsource</div><div class="line">iptables -A BADDNS -m recent --update --seconds <span class="number">10</span> --hitcount <span class="number">1</span> --name DNSQF --rsource -j DROP</div></pre></td></tr></table></figure>

<p>添加以上规则后执行 <code>iptables-save</code> 来使更改生效。</p>
<p>目前为止似乎没有报告出现了明显规模的 DNS 放大攻击征兆，攻击者针对我们防火墙封锁的反应速度、攻击所用的记录以及从日志中发现的大量不同请求源也暗示着我们的服务器可能是最终攻击目标，用攻击流量消耗尽服务器带宽而导致服务瘫痪。至于原因，我也没有想明白为何会有攻击者对一个小型私用服务器感兴趣。</p>
<p>PS. 到本文发表时，攻击依旧在继续，且流量越来越大。目前阿里云的云盾设置可以说无力，只能依靠 iptables 暂时缓解。后续的应对计划仍在制定中。</p>
<p>=== 2014-05-24 更新 ===</p>
<p>Aveline 菊苣给出了一个<a href="https://github.com/smurfmonitor/dns-iptables-rules" target="_blank" rel="external">DNS Amplification IPTABLES block lists</a> 给点 128 个赞！</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-19T03:18:20.000Z"><a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">2014-05-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">在异步方法中使用 for 循环，以及循环中包含异步方法的几点坑</a></h1>
  

    </header>
    <div class="entry">
      
        <p>又是熬夜干活。</p>
<p>之前在 StackOverflow 上看到过 <a href="http://stackoverflow.com/questions/5050265/javascript-nodejs-is-array-foreach-asynchronous" target="_blank" rel="external">Array.forEach 是同步 (阻塞) 的</a>，但是实际使用的时候，特别是我在写 Node.js 程序的时候几乎没感觉到过它的阻塞—— forEach 或者其他 for 循环之后的 callback 从来都是被立即调用，没有等待整个循环执行完。&lt;== 这个命题是个假命题，下面会说明。</p>
<p>今天又一次掉进异步的坑里才发现 for 循环确实是阻塞的。至于为何它后面的回调函数会立即被调用，原因是 for 循环里有异步方法。整个循环不会等待异步方法结束，而是直接进入下一个循环，所以它 <strong>看起来</strong> 像是异步的，后面的回调函数「立即」被调用了。<a href="http://stackoverflow.com/questions/21184340/async-for-loop-in-node-js" target="_blank" rel="external">StackOverflow</a> 上有更详细的例子和说明。</p>
<p>不过如果是数组，那么直接使用 <a href="https://github.com/caolan/async" target="_blank" rel="external">async</a> 替代原生的 forEach 和其他 for 语句即可简单解决。但是问题出在我这里的情况是要用 <code>for in</code> 语句处理 Object，虽说 Javascript 里 Object 和 Array 非常相似但是毕竟没有 Array 那些好用的方法，在这种情况下也不方便使用 prototype 来给我的 object 新增类似方法。二小姐给出的解决方案是手动设置计数器，获得 object 长度的办法是使用 <code>Object.keys(obj).length</code>。</p>
<p><strong>注意</strong> <code>Object.keys(obj).length</code> 并不一定是要循环的次数，具体需要看 Object 的结构。我这里就是解析 DOM 得到的 Object 所以有额外的东西，<code>length - 3</code> 才是需要的结果。</p>
<p>代码写出来大概是这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(obj, callback)</span> {</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> tasks = <span class="built_in">Object</span>.keys(obj).length;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> arr = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {</div><div class="line">	</div><div class="line">	tasks--;</div><div class="line">	</div><div class="line">	async.eachSeries(arr, someFunc(n, cb) {</div><div class="line">	</div><div class="line">	    <span class="comment">// do stuff here.</span></div><div class="line">	    </div><div class="line">	    cb();</div><div class="line">	</div><div class="line">	}, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line">	</div><div class="line">	    <span class="comment">// operations after array iteration completed.</span></div><div class="line">	    </div><div class="line">	    <span class="keyword">if</span> (tasks === <span class="number">0</span>) {</div><div class="line">	    </div><div class="line">		<span class="comment">// All tasks done, return to callback</span></div><div class="line">		<span class="keyword">return</span> callback();</div><div class="line">	    </div><div class="line">	    }</div><div class="line">	    </div><div class="line">	});</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>判断的语句其实也可以放在 <code>async.eachSeries</code> 之后，这样可以明显减少判断的计算 (虽然那点计算不算啥) 但是也有可能会在没等待最后一次 async 执行结束的时候就返回了，所以保险起见还是多花点处理器来保证全部任务执行完。以及在最后 <code>callback</code> 的时候如果不写 <code>return</code> 就会失效。我还没查原因，因为已经累得不行了… 所以(当回伸手党) 如果哪位童鞋知道的麻烦告知… 有灵梦的节操相送哦 &gt;///&lt;</p>
<p>==== 2014-05-20 更新 ====</p>
<p>感谢 Xuetian Weng 菊苣为了灵梦的节操不远万里给我纠错 /w\ 上面的代码在 <code>async.eachSeries</code> 里有异步方法时存在多次 <code>tasks === 0</code> 的情况，因为同样的因为 <code>for in</code> 循环不会等待 async 结束，async 的回调不一定会在 <code>tasks</code> 下一次自减之前被调用。解决办法是 <code>tasks--</code> 放在 <code>async.eachSeries</code> 的回调函数里。更好些的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(obj, callback)</span> {</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> tasks = <span class="built_in">Object</span>.keys(obj).length;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> arr = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {</div><div class="line"></div><div class="line">        async.eachSeries(arr, someFunc(n, cb) {</div><div class="line"></div><div class="line">            <span class="comment">// do stuff here.</span></div><div class="line"></div><div class="line">            cb();</div><div class="line"></div><div class="line">        }, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line"></div><div class="line">            <span class="comment">// operations after array iteration completed.</span></div><div class="line">	    </div><div class="line">            <span class="comment">// tasks self-decrease should be here to ensure every async.eachSeries call has ended.</span></div><div class="line">            tasks--;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (tasks === <span class="number">0</span>) {</div><div class="line"></div><div class="line">                <span class="comment">// All tasks done, return to callback</span></div><div class="line">                <span class="keyword">return</span> callback();</div><div class="line"></div><div class="line">            }</div><div class="line"></div><div class="line">        });</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>不过菊苣说最后的 return 是可有可无，我这里的测试是不加 return (不管是在前面还是后面) 这个 callback 都不会被正确调用… 所以 return 的问题并没有算是解决，于是放到后面有时间的话来满满折腾吧~ 看 Xuetian Weng 菊苣如此渴求节操的表情咱就给一点表示感谢好了呜(双手奉上</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-17T15:59:48.000Z"><a href="/2014/05/17/repo-arm-disk-rescue-and-resize/">2014-05-17</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/17/repo-arm-disk-rescue-and-resize/">修复 Arch Rollback Machine 磁盘占用</a></h1>
  

    </header>
    <div class="entry">
      
        <p>最近发现 downgrade 失效了，降级啥包都是直接错误退出。然后排查的时候发现是 Arch Rollback Machine 挂了，原因是——磁盘不足。</p>
<p>检查后发现 pm2 的日志有 7G，850 天前的包有 5000 多个，365 天内的包有 10 万余，磁盘已经被吃得满满当当。</p>
<p>日志好说，因为没啥特别有用的东西也不用拿来做分析，直接删掉就好。Felix 也把 850 天前的包全部删干净了。不过再次检查的时候 <code>df -h</code> 显示依旧是磁盘被吃满的，而 <code>df -ih</code> 显示 inode 占用没有问题。猫怀疑是有文件句柄还开着，但是把所有可能的进程杀掉之后依旧没有变化，排除。另外一个现象是文件删除进程完成后过了一段时间磁盘开始有少量空闲空间了，可能是磁盘缓存…? </p>
<p>于是靠着这空出来的 900M 多点的空间执行了几个操作：把有 HTTP flood 漏洞的 Node.js 0.10.16 升级到最新版 0.10.28，将包同步的 cronjob 降低到每天执行一次，压缩旧的 NGINX 日志。</p>
<p>以及用户一直要求的包归档功能，实际上是已经有了的，但是并没通过 NGINX 配置来实现 (Pia!&lt;(=ｏ ‵-′) ノ☆猫) 所以准备把归档功能写到 API 服务端里。因为之前很有预见性的同步的时候把每天的包数据库按照 <code>/year/month/day/repo</code> 的结构保存起来(然后这部分的数据库文件就有 30G！)，所以用户按照这个路径来请求包数据库的时候直接把对应的数据库文件丢给客户端，请求包文件的时候则直接从包目录里丢过去。这样的话其实从一个较早的时间结构最后请求一个较新的包文件也能拿到…. 不过这个不是问题，因为包归档给 pacman 用的话，有哪些包还是 pacman 要读数据库的。</p>
<p>包归档的 index 确实花了不少时间，目前的实现貌似也不很好，虽然貌似还挺快的，但是也挺吃硬盘的…而且一连好几次手残敲错了东西、少加了分隔符、加了冗余的配置变量…. 总之就是爆肝熬夜的效率超级差，4 点多基本上没问题的时候已经能感觉到身体很不舒服了…</p>
<p>然后是一觉睡到第二天中午。觅食归来给 A.R.M 的 KVM 虚拟机硬盘增加了 100G。执行 <code>resize2fs</code> 的时候报错说已经达到最大空间，删掉 swap 之后依旧。接下来干了一件很作死的事情——把所有分区删掉了，然后按照原来的分区方案重建了新的分区。Reboot 之后 lsblk 是对了，但是 df -h 依旧是原来的分区。一叶说是 resize 没成功，要进 LiveCD 里面 resize2fs。不过我没镜像… 按照一叶的建议挂上 VNC 进 recovery 然后 fsck，再正常进系统执行 <code>resize2fs</code>，成功。</p>
<p>回过神来的时候发现这种作死的行为我居然手都没抖一下 = = 几百 G 的数据呐…</p>
<p>晚上还要做字幕，再去休息下好了…</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-15T21:57:19.000Z"><a href="/2014/05/16/accelerate-apple-services-in-cn/">2014-05-16</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/16/accelerate-apple-services-in-cn/">为国内用户加速 Apple 服务</a></h1>
  

    </header>
    <div class="entry">
      
        <p>偶然看到 <a href="https://plus.google.com/105938465531761409080/posts/3EXLAUerxMD" target="_blank" rel="external"> 雅诗的 po</a> 才发觉自己 DNS 的 Apple 服务加速已经几乎不能用了，速度非常慢。倒是挺奇怪的，因为自己做的 DNS 服务器对于整个 Apple 域的上游都是 V2EX DNS，难道是 V2EX DNS 出问题了？</p>
<p>总之先不管那些。现在来简单做一份 Apple 服务加速的配置。</p>
<p>稍微 Google 下 Apple 的服务地址，目前获得的地址如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">a{<span class="number">1</span>-<span class="number">2000</span>}<span class="preprocessor">.phobos</span><span class="preprocessor">.apple</span><span class="preprocessor">.com</span></div><div class="line">swdist<span class="preprocessor">.apple</span><span class="preprocessor">.com</span></div><div class="line">itunes<span class="preprocessor">.apple</span><span class="preprocessor">.com</span></div><div class="line">contentdelivery<span class="preprocessor">.itunes</span><span class="preprocessor">.apple</span><span class="preprocessor">.com</span></div></pre></td></tr></table></figure>

<p>对应在国内的 CDN 地址是</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">a1-a200<span class="preprocessor">.phobos</span><span class="preprocessor">.apple</span><span class="preprocessor">.chinacache</span><span class="preprocessor">.net</span></div><div class="line">swdist<span class="preprocessor">.apple</span><span class="preprocessor">.ccgslb</span><span class="preprocessor">.net</span></div><div class="line">itunes<span class="preprocessor">.apple</span><span class="preprocessor">.ccgslb</span><span class="preprocessor">.com</span><span class="preprocessor">.cn</span></div><div class="line">(最后一个没找到 CDN 地址..)</div></pre></td></tr></table></figure>

<p>然后根据 114DNS 和 Google DNS 综合查询以上地址的 IP。顺便发现地址里有 <code>cnc</code>, <code>cncssr</code> 这样的关键字，于是正好尝试把 <code>cnc</code> 改成 <code>tel</code> 于是得到了电信节点的 IP。</p>
<p>现在写一个两句话的 js 脚本来生成一份针对 <code>a{1-2000}.phobos.apple.com</code> 的加速列表(废话这种东西能手写吗要累死啦)，以达到尽可能将电信、联通的节点混在一起，保证各个 ISP 用户的下载速度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Accelerate IPs for Apple download service.</span></div><div class="line"><span class="comment">// apple-ips.js</span></div><div class="line"><span class="keyword">var</span> ips = [</div><div class="line">  <span class="string">'221.192.144.12'</span>,</div><div class="line">  <span class="string">'182.118.46.137'</span>,</div><div class="line">  <span class="string">'124.95.150.148'</span>,</div><div class="line">  <span class="string">'123.235.32.2'</span>,</div><div class="line">  <span class="string">'119.84.69.17'</span>,</div><div class="line">  <span class="string">'122.228.85.196'</span>,</div><div class="line">  <span class="string">'115.231.150.15'</span>,</div><div class="line">  <span class="string">'61.164.153.7'</span>,</div><div class="line">  <span class="string">'183.57.28.18'</span></div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">2000</span>; i++) {</div><div class="line">  console.log(ips[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*ips.length)] + <span class="string">'a'</span> + i + <span class="string">'.phobos.apple.com'</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~&gt; node apple-ips<span class="preprocessor">.js</span> &gt; apple<span class="preprocessor">.conf</span></div></pre></td></tr></table></figure>

<p>就得到一份可以直接用的加速列表啦。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-07T11:46:09.000Z"><a href="/2014/05/07/new-njlug-homepage/">2014-05-07</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/07/new-njlug-homepage/">新的 NJLUG 主站</a></h1>
  

    </header>
    <div class="entry">
      
        <p>南京 Linux 用户组有一段时间没有聚会了。偶然想起来之前我用 Jekyll 折腾的那个主页，随手敲了主页地址… 啊啦，还基本上没变啊…</p>
<p>嘛虽然自己写了那么几个东西，不过在组里待了也有一段时间也学到了不少东西。用户对社区的回报应该就在这时候展现出来吧。</p>
<p>依旧是 Express.js 框架，依旧是 Bootstrap。不过这回不想用数据库了，改用文本存储。除了主页和关于，顺便集成一个 Planet 在里面。RSS feed 的话，除了遍历一遍 upsert (不存在的添加，已存在的跳过)之外没想到什么更好的办法。实际上本来就是 RSS 没必要存储所有的文章，更何况又不是做之前想做的类似 Google Reader 的东西。</p>
<p>目前的 Planet 工作方式为首先检测是否存在文章数据文件 <code>posts.array</code>，如果不存在则读取 <code>planet.list</code> 中的订阅链接，获取到文章后 push 到一个数组中，按照发表日期排序并保存在 <code>posts.array</code> 里。到底是先排序再保存还是先存进去，渲染页面的时候再排序，这个稍微纠结了下。因为自己的配置文件里更新频率是 1 hour, 而且似乎每次更新到的文章数量还挺多的。所以保存时排序的话，则每天固定排序 23 次；如果渲染时排序的话，就看每天能有几个访问了…. 然后发现自己在这种小问题上纠结个毛毛啊啊啊啊啊。</p>
<p>排序后保存进文件之前和从文件读出之后要有两个 JSON 操作。保存之前 <code>JSON.stringify(posts)</code> 转换成字符串再保存，否则文件里是 <code>[[object Object], [object Object]]</code>。读出来之后 <code>JSON.parse(posts)</code> 再转换成对象数组，否则直接就一字符串没办法处理。</p>
<p>接下来就是主页和关于。因为不想写用户系统了所以就不发文章了吧… 关于可以是万年不变的页面，首页的话，显示最近的公告好了。最简单的实现就是存两个 markdown 文件然后用 marked 渲染出来插在页面里。</p>
<p>全部的源码在 <a href="https://github.com/phoenixlzx/NJLUG-site" target="_blank" rel="external"> 这里</a>。</p>
<p>目前似乎域名还没解析，田华兄也未必决定用这个.. 所以效果的话戳 <a href="http://njlug.phoenixlzx.com" target="_blank" rel="external"> 这里 </a> 看。</p>
<p>然后顺便说一句.. 现在已经健忘到我已经忘记刚刚想起来要写的东西了<em>(:з」∠)</em></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.phoenixlzx.com">
  </form>
</div>

  <div class="widget tag">
    <h3 class="title">关于</h3>
    <div class="entry">
        <img src="/static/img/avatar/avatar.jpg" style="margin: auto; width: 100%;"/>
        <h4 style="text-align: center">Phoenix Nemo (phoenixlzx)</h4>
        <div style="margin: auto; text-align: center;">
            <a href="https://plus.google.com/107142103119739092775" target="_blank"><i class="fa fa-google-plus fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://twitter.com/phoenixlzx" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://github.com/phoenixlzx" target="_blank"><i class="fa fa-github fa-2x"></i></a>&nbsp;&nbsp;
            <a class="fancybox" href="#emailme"><i class="fa fa-envelope-o fa-2x"></i></a>
        </div>
        <div style="display: none;">
            <div id="emailme">
                <p><strong>个人邮箱地址</strong></p>
                <br/>
                <code>echo 'aUBwaG9lbml4bHp4LmNvbQo='|base64 --decode</code>
            </div>
        </div>
    </div>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Algorithm/">Algorithm</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>4</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>2</small></li>
  
    <li><a href="/categories/Network/">Network</a><small>3</small></li>
  
    <li><a href="/categories/Nodejs/">Node.js</a><small>5</small></li>
  
    <li><a href="/categories/Notes/">Notes</a><small>8</small></li>
  
    <li><a href="/categories/Practise/">Practise</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Algorithm/" style="font-size: 10.00px;">Algorithm</a><a href="/tags/Anime/" style="font-size: 16.00px;">Anime</a><a href="/tags/Artwork/" style="font-size: 10.00px;">Artwork</a><a href="/tags/Configuration/" style="font-size: 12.00px;">Configuration</a><a href="/tags/DKMS/" style="font-size: 10.00px;">DKMS</a><a href="/tags/DNS/" style="font-size: 14.00px;">DNS</a><a href="/tags/FFmpeg/" style="font-size: 14.00px;">FFmpeg</a><a href="/tags/Fibonacci/" style="font-size: 10.00px;">Fibonacci</a><a href="/tags/Filesystem/" style="font-size: 10.00px;">Filesystem</a><a href="/tags/ImageMagick/" style="font-size: 10.00px;">ImageMagick</a><a href="/tags/KDE/" style="font-size: 10.00px;">KDE</a><a href="/tags/Kernel/" style="font-size: 10.00px;">Kernel</a><a href="/tags/Linux/" style="font-size: 14.00px;">Linux</a><a href="/tags/Minecraft/" style="font-size: 12.00px;">Minecraft</a><a href="/tags/MongoDB/" style="font-size: 10.00px;">MongoDB</a><a href="/tags/Multimedia/" style="font-size: 14.00px;">Multimedia</a><a href="/tags/MyPet/" style="font-size: 10.00px;">MyPet</a><a href="/tags/Network/" style="font-size: 14.00px;">Network</a><a href="/tags/Nodejs/" style="font-size: 20.00px;">Node.js</a><a href="/tags/Practise/" style="font-size: 10.00px;">Practise</a><a href="/tags/Script/" style="font-size: 10.00px;">Script</a><a href="/tags/Server/" style="font-size: 18.00px;">Server</a><a href="/tags/Ubuntu/" style="font-size: 14.00px;">Ubuntu</a><a href="/tags/VPN/" style="font-size: 10.00px;">VPN</a><a href="/tags/WordPress/" style="font-size: 10.00px;">WordPress</a><a href="/tags/iptables/" style="font-size: 12.00px;">iptables</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2014/07/21/setup-openconnect-server-on-ubuntu/">在 Ubuntu 服务器上搭建 OpenConnect 服务器小记</a>
      </li>
    
      <li>
        <a href="/2014/05/24/iptables-rate-limiting-rules-to-block-dns-amplification-attack/">使用 iptables 过滤 DNS 放大攻击</a>
      </li>
    
      <li>
        <a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">在异步方法中使用 for 循环，以及循环中包含异步方法的几点坑</a>
      </li>
    
      <li>
        <a href="/2014/05/17/repo-arm-disk-rescue-and-resize/">修复 Arch Rollback Machine 磁盘占用</a>
      </li>
    
      <li>
        <a href="/2014/05/16/accelerate-apple-services-in-cn/">为国内用户加速 Apple 服务</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Phoenix Nemo
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'phoenixhexo';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js?https';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>