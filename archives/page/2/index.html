<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    
    <title>第 2 页 | 归档 | Phoenix&#39;s island</title>
    <meta name="author" content="Phoenix Nemo">
    
    <meta name="description" content="Phoenix&#39;s Blog">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <meta property="og:site_name" content="Phoenix&#39;s island"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link href="/favicon.png" rel="icon">
    <link rel="alternate" href="/atom.xml" title="Phoenix&#39;s island" type="application/atom+xml">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.css"/>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Phoenix&#39;s island</a></h1>
  <h2><a href="/">Sun will shine on the horizon.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/links">Links</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">归档</h2>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-10T16:26:48.000Z"><a href="/2014/03/11/browser-from-a-to-z/">2014-03-11</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/11/browser-from-a-to-z/">浏览器A到Z</a></h1>
  

    </header>
    <div class="entry">
      
        <p> 貌似很好玩的样子？</p>
<ul>
<li><strong>A</strong> amazon.cn</li>
<li><strong>B</strong> bbs.archlinuxcn.org</li>
<li><strong>C</strong> cp.ultrakvm.com</li>
<li><strong>D</strong> drive.google.com</li>
<li><strong>E</strong> expressjs.com</li>
<li><strong>F</strong> foundation.zurb.com</li>
<li><strong>G</strong> github.com</li>
<li><strong>H</strong> he.net</li>
<li><strong>I</strong> ituring.com.cn</li>
<li><strong>J</strong> jsfiddle.net</li>
<li><strong>K</strong> kde.org</li>
<li><strong>L</strong> lixian.xunlei.com</li>
<li><strong>M</strong> moedns.com</li>
<li><strong>N</strong> npmjs.org</li>
<li><strong>O</strong> ovh.com</li>
<li><strong>P</strong> plus.google.com</li>
<li><strong>Q</strong> qingcloud.com</li>
<li><strong>R</strong> readthedocs.org</li>
<li><strong>S</strong> stackoverflow.com</li>
<li><strong>T</strong> twitter.com</li>
<li><strong>U</strong> u2.dmhy.org</li>
<li><strong>V</strong> versaweb.com</li>
<li><strong>W</strong> wiki.archlinux.org</li>
<li><strong>X</strong> xehost.com</li>
<li><strong>Y</strong> yande.re</li>
<li><strong>Z</strong> zh.minecraftwiki.net</li>
</ul>
<p> 发现各种不科学 = =… 而且这也只是我最近的记录而已吧 →_→</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-23T10:39:58.000Z"><a href="/2014/02/23/kernel-hook-auto-build-dkms-modules/">2014-02-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/23/kernel-hook-auto-build-dkms-modules/">自动编译 DKMS 模组的内核 HOOK</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://en.wikipedia.org/wiki/Dynamic_Kernel_Module_Support" target="_blank" rel="external">DKMS</a> 是个好东西，像我们这些喜欢自定义内核的家伙有了 DKMS 之后就不用为各种第三方的内核模组发愁了～</p>
<p>于是也没看是不是有人做过了(基本上是有人做了吧…) 于是参照 <a href="https://aur.archlinux.org/packages/nvidia-hook/" target="_blank" rel="external">nvidia-hook</a> 做了一个 <a href="https://aur.archlinux.org/packages/autodkms/" target="_blank" rel="external">autodkms</a>。</p>
<p>按照 <a href="https://wiki.archlinux.org/index.php/Dynamic_Kernel_Module_Support" target="_blank" rel="external">ArchWiki</a>，自动编译所有模组的命令是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dkms autoinstall <span class="attribute">-k</span> NEW_KERNEL_VERSION</div></pre></td></tr></table></figure>

<p>于是照葫芦画瓢写的 hook 文件 <code>/usr/lib/initcpio/install/autodkms</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">build</span></span> ()</div><div class="line">{</div><div class="line">  <span class="built_in">echo</span> <span class="string">"Building dkms modules for <span class="variable">${KERNELVERSION}</span> kernel..."</span></div><div class="line">  dkms autoinstall -k <span class="variable">${KERNELVERSION}</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"Build complete."</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="title">help</span></span> ()</div><div class="line">{</div><div class="line">cat&lt;&lt;HELPEOF</div><div class="line">    This hook rebuilds all dkms modules <span class="keyword">for</span> new kernel.</div><div class="line">HELPEOF</div><div class="line">}</div></pre></td></tr></table></figure>

<p>全部源码在 <a href="https://github.com/phoenixlzx/autodkms" target="_blank" rel="external"> 这里 </a> <del> 其实一共就几行…</del></p>
<p>打包好之后在 <code>/etc/mkinitcpio.conf</code> 的 <code>HOOKS</code> 最后加上 <code>autodkms</code> 就可以在更新内核的时候重新编译所有模组啦。</p>
<p>=== 2014-03-10 更新 ===</p>
<p>在没有装对应内核的 headers 之前脚本执行会出错——</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Building dkms modules <span class="keyword">for</span> <span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts kernel...</div><div class="line"><span class="keyword">Error</span>! echo</div><div class="line">Your kernel headers <span class="keyword">for</span> kernel <span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts cannot be found at</div><div class="line">/usr/<span class="keyword">lib</span>/modules/<span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts/build <span class="keyword">or</span> /usr/<span class="keyword">lib</span>/modules/<span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts/source.</div><div class="line"><span class="keyword">Error</span>! echo</div><div class="line">Your kernel headers <span class="keyword">for</span> kernel <span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts cannot be found at</div><div class="line">/usr/<span class="keyword">lib</span>/modules/<span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts/build <span class="keyword">or</span> /usr/<span class="keyword">lib</span>/modules/<span class="number">3.10</span><span class="number">.33</span>-<span class="number">1</span>-lts/source.</div><div class="line">Build complete.</div></pre></td></tr></table></figure>

<p>但是一般升级的时候都是先装内核再装 headers 所以脚本可以完善下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">build</span></span> ()</div><div class="line">{</div><div class="line">  <span class="keyword">if</span> [! <span class="operator">-d</span> <span class="string">"/usr/lib/modules/<span class="variable">${KERNELVERSION}</span>/build"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"You need to install or update <span class="variable">${KERNELVERSION}</span> headers before build kernel image."</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"Building dkms modules for <span class="variable">${KERNELVERSION}</span> kernel..."</span></div><div class="line">  dkms autoinstall -k <span class="variable">${KERNELVERSION}</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"Build complete."</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="title">help</span></span> ()</div><div class="line">{</div><div class="line">cat&lt;&lt;HELPEOF</div><div class="line">    This hook rebuilds all dkms modules <span class="keyword">for</span> new kernel.</div><div class="line">HELPEOF</div></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-19T14:03:05.000Z"><a href="/2014/02/19/make-gif-with-ffmpeg/">2014-02-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/19/make-gif-with-ffmpeg/">使用 FFmpeg 制作 GIF</a></h1>
  

    </header>
    <div class="entry">
      
        <p>貌似好久之前秋水学姐就问过如何制作 GIF，回想当时制作境界の彼方中「約束の絆」的<a href="https://plus.google.com/u/0/+PhoenixNemo/posts/RqPTgGrksLV" target="_blank" rel="external">GIF 动画</a>，现在也已经把命令忘光了。所以觉得还是稍微做个笔记。</p>
<p>只需要用到 FFmpeg。绝大多数发行版都已经将它收录官方仓库，通过包管理器就可以安装。</p>
<p>假设我们需要转换的视频文件是 <code>input.ogg</code>，输出的 GIF 文件是 <code>output.gif</code>。这里不讨论如何截取视频中的段落 (因为命令太繁<del> 烦</del>琐了)等视频剪辑的问题，需要转换的视频已经经过简单处理，可以直接使用。</p>
<p>基本命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ffmpeg -i input<span class="preprocessor">.ogg</span> output<span class="preprocessor">.gif</span></div></pre></td></tr></table></figure>

<p>第一次制作的 gif 就是这么来的。然后当我试图上传到 Google+ 的时候发现…</p>
<p><strong>区区几百 KB 的视频片段制作出来的 GIF 竟然有 20M 之巨啊！</strong> <del>原视频是 1080p 50fps 的 flv</del></p>
<p>于是需要两个参数，一个是缩小分辨率一个是减少帧数。50 帧确实少见，但是一般来讲 gif 有 15 帧左右就比较流畅了。命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ffmpeg <span class="attribute">-i</span> input<span class="built_in">.</span>ogg <span class="attribute">-s</span> <span class="number">640</span>x320 <span class="attribute">-r</span> <span class="number">15</span> output<span class="built_in">.</span>gif</div></pre></td></tr></table></figure>

<p>很多人喜欢把 <code>-r</code> 选项放在前面… 按照某个早就忘记在哪的邮件列表里的说法，<code>-r</code> 放在 <em>输入文件 </em> 的 <strong> 后面 </strong> 才是输出文件的效果。上面的命令出来的结果就是分辨率为<code>640×320</code>，帧率为 15 的 gif 了。<code>640x320</code> 中间是小写字母 <code>x</code> <del> 别像某人一样特地复制了一份 <code>×</code> 进去…</del></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-17T19:49:22.000Z"><a href="/2014/02/18/file-upload-with-expressjs-and-formidable/">2014-02-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/18/file-upload-with-expressjs-and-formidable/">使用 Express.js 和 Formidable 上传文件</a></h1>
  

    </header>
    <div class="entry">
      
        <p> 写 <a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/"> 之前一篇文章 </a> 时发现 Express.js 更新到 3.4.x 了，运行的时候出现警告 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">connect</span>.multipart() will be removed in <span class="keyword">connect</span> <span class="number">3.0</span></div><div class="line">visit https:<span class="regexp">//github</span>.com/senchalabs/<span class="keyword">connect</span>/wiki/Connect-<span class="number">3.0</span> <span class="keyword">for</span> alternatives</div><div class="line"><span class="keyword">connect</span>.limit() will be removed in <span class="keyword">connect</span> <span class="number">3.0</span></div></pre></td></tr></table></figure>

<p> 按照 Wiki 的指引看了下 <code>multiparty</code>，<code>connect-multiparty</code> 和 <code>formidable</code>，最终选用了 <code>formidable</code> <del> 因为说明看起来很碉堡的样子 </del></p>
<p> 简单写了两个路由控制，按照 <a href="https://github.com/felixge/node-formidable" target="_blank" rel="external">node-formidable</a> 的示例加上了打印文件上传信息的几个语句，运行时发现程序 hang 了…</p>
<p>Google 许久无果——找到的结果基本都是要你注释掉 <code>app.use(express.bodyParser())</code>，而我已经是 express 3.4 所以早就没有 bodyParser 了。回去又看 formidable 给的例子，于是发现自己犯二了…——</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/upload"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span></div></pre></td></tr></table></figure>

<p> 真是个バカ！</p>
<p> 立马给 <code>index.ejs</code> 中的 form 部分加上了 <code>enctype=&quot;multipart/form-data&quot;</code>，重试，成功。 <del> 于是就这么解决了 </del>(被打飞 </p>
<p> 主程序 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</div><div class="line"><span class="keyword">var</span> formidable = <span class="built_in">require</span>(<span class="string">'formidable'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(express.favicon());</div><div class="line">app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.urlencoded());</div><div class="line">app.use(express.methodOverride());</div><div class="line">app.use(app.router);</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.render(<span class="string">'index'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/upload'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">var</span> form = <span class="keyword">new</span> formidable.IncomingForm();</div><div class="line"></div><div class="line">    form.parse(req, <span class="function"><span class="keyword">function</span><span class="params">(err, fields, files)</span> {</span></div><div class="line">        res.writeHead(<span class="number">200</span>, {<span class="string">'content-type'</span>: <span class="string">'text/plain'</span>});</div><div class="line">        res.write(<span class="string">'received upload:\n\n'</span>);</div><div class="line">        res.end(util.inspect({fields: fields, files: files}));</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port'</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p> 以及一个简单的 <code>index.ejs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Upload test<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">href</span>=<span class="value">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>Test formidable<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/upload"</span> <span class="attribute">method</span>=<span class="value">"post"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"textfield"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">name</span>=<span class="value">"file"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"submit"</span>&gt;</span>Upload<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>PS. <a href="http://stackoverflow.com/a/5543851" target="_blank" rel="external"> 后来发现确实有人遇到这个问题了…</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-16T19:19:34.000Z"><a href="/2014/02/17/nyaabot-bot-for-nyaacat-irc/">2014-02-17</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/17/nyaabot-bot-for-nyaacat-irc/">Nyaabot: 为喵窝服务器构建的 IRC 机器人</a></h1>
  

    </header>
    <div class="entry">
      
        <p>第一次写 IRC 机器人。之前已经看到仙子酱等等菊苣们写了好多种 IRC 机器人，但是都是 Python 写的。倒不是歧视 Python 啊什么的… 主要是咱服务器上木有方便的环境跑，而且也有需要自己做的功能。正好在逛 NPM 的时候发现了 <a href="https://npmjs.org/node-irc" target="_blank" rel="external">node-irc</a> 这个包，于是折腾一下午搞出来一个机器人程序。</p>
<p>目前主要纠结的问题是 IRC 没有类似 HTTP Status code 或者类似的指示代码，所以我能想到的处理办法就是验证字符串。好吧我承认这种方法很不靠谱，但是… 各种求靠谱方法啊…</p>
<h3 id="客户端配置">客户端配置</h3>
<p>专门写了一个 <code>config.js</code> 来保存客户端的配置。根据 <a href="https://node-irc.readthedocs.org/en/latest/index.html" target="_blank" rel="external">node-irc 的文档</a>，在程序中做如下参数设定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">serveroptions: {</div><div class="line">    userName: <span class="string">'nyaabot'</span>,</div><div class="line">    realName: <span class="string">'Nyaacat IRC Bot'</span>,</div><div class="line">    port: <span class="number">7000</span>,</div><div class="line">    debug: <span class="literal">false</span>,</div><div class="line">    showErrors: <span class="literal">false</span>,</div><div class="line">    autoRejoin: <span class="literal">true</span>,</div><div class="line">    autoConnect: <span class="literal">true</span>,</div><div class="line">    channels: [<span class="string">'#nyaacat'</span>],</div><div class="line">    secure: <span class="literal">true</span>,</div><div class="line">    selfSigned: <span class="literal">false</span>,</div><div class="line">    certExpired: <span class="literal">false</span>,</div><div class="line">    floodProtection: <span class="literal">true</span>,</div><div class="line">    floodProtectionDelay: <span class="number">1000</span>,</div><div class="line">    sasl: <span class="literal">false</span>,</div><div class="line">    stripColors: <span class="literal">true</span>,</div><div class="line">    channelPrefixes: <span class="string">"&#"</span>,</div><div class="line">    messageSplit: <span class="number">512</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>看起来都是很好懂的嗯。昨天在配置 CraftIRC 插件的时候撞到一个坑，NickServ 一直报错说参数不完整。调了半天发现是这里的 <code>realName</code> 部分没有填写，于是这次特地写上了注释要求该项必须填写。</p>
<h3 id="帐户验证">帐户验证</h3>
<p>之后发现木有类似验证帐号的部分。查了下找到了 <a href="https://github.com/martynsmith/node-irc/issues/205" target="_blank" rel="external">issue #205</a>。原来验证并没有在 IRC RFC 里规定，因此没有包含在库里。嘛好吧，只好自己写了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">nyaa.addListener(<span class="string">"notice"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(from, to, text, message)</span> {</span></div><div class="line">    <span class="comment">// console.log(from + '\n' + to + '\n' + text + '\n' + util.inspect(message, false, null));</span></div><div class="line">    <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'This nickname is registered. Please choose a different nickname, or identify via /msg NickServ identify &lt;password&gt;.'</span>) {</div><div class="line">        nyaa.say(<span class="string">'NickServ'</span>, <span class="string">'identify'</span> + config.password);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'You are now identified for'</span> + config.serveroptions.userName) {</div><div class="line">        console.log(<span class="string">'Login success.'</span>);</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'Invalid password for'</span> + config.serveroptions.userName) {</div><div class="line">        console.log(<span class="string">'Incorrect password. check you config!'</span>);</div><div class="line">    }</div><div class="line">});</div></pre></td></tr></table></figure>

<p>嗯现在就是验证字符串… 所以似乎只能在 freenode 上跑，其他 IRC 服务器是不是这样就不知道了。测试了下表示没问题，收到登陆成功的提示了。</p>
<h3 id="消息处理">消息处理</h3>
<p>目前不准备做私信支持，所以在收到 pm 的时候直接丢一句话过去就可以了。顺便，可以做成自定义消息的说，于是加上了 <code>messages.js</code> 包含所有的可自定义消息。</p>
<p>然后是最重要的功能之一——命令。没命令的 bot 不是好 bot 嗯。编写程序时候的想法是命令以特定字符开头，但是后面如何验证，用 Stackoverflow 上扒来的 <code>startsWith</code> 和 <code>endsWith</code> 函数似乎不能做到足够准确，所以暂且用一个字母加参数来作为命令好了。首先想到的命令功能是搜索 Wiki。毕竟 Minecraft 游戏有够复杂即便是老玩家也不一定能记住 Wiki 里的所有内容。这里想要实现的效果是，提交关键字，返回搜索到的页面链接，并发送该页面的内容总结——也就是 Mediawiki 页面的 section 0。</p>
<p>这里用到了 <code>request</code> 模块，因为 <code>http.get</code> 被弃用且 <code>http.request</code> 说实话用起来比较不爽。<code>request</code> 可以轻松得到页面内容。根据 <a href="http://en.wikipedia.org/w/api.php" target="_blank" rel="external">Mediawiki API</a> 确定使用如下 2 个请求参数：</p>
<ul>
<li><code>/api.php?action=query&amp;format=xml&amp;titles=[页面标题]</code></li>
<li><code>/api.php?format=json&amp;action=parse&amp;prop=text&amp;section=0&amp;page=[页面标题]</code></li>
</ul>
<p>话说我倒是想都用 JSON 的，毕竟 Javascript 原生支持的东西。但是但是第一个 API 返回的 JSON 居然把页面的 pageid 作为 key 啦！你这要我如何是好，为了拿你一个 key/value 要麻烦死了哦。所以还是选择了 XML 并且使用了 <a href="https://github.com/Leonidas-from-XIV/node-xml2js" target="_blank" rel="external">xml2js</a> 这个库。</p>
<p>第二个 API 的数据处理其实一开始也是用的 XML，因为返回的 JSON 里一个 key 是 <code>*</code>，然后我就 <del>很丢脸的</del> 不知所错了… 问了仙子才知道这种带有特殊符号的使用方法是…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    <span class="string">"v"</span>: {</div><div class="line">	      <span class="string">"*"</span>:{</div><div class="line">			<span class="string">"key1"</span>: <span class="string">"value1"</span>,</div><div class="line">			<span class="string">"key2"</span>: <span class="string">"value2"</span></div><div class="line">		  }</div><div class="line">	  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这样的拿到 <code>*</code> 的属性值的方法是 <code>v[&#39;*&#39;]</code> ……… <del>基本功不扎实，实在是太丢脸了 &gt;////&lt;</del></p>
<p>于是拿到了返回文章 summary 的 HTML 代码。先是用正则去掉所有的 HTML Tag 和 <code>\n \r</code> 等换行符，然后发现 HTML 实体没有被转换，于是偷懒用了 <a href="https://www.npmjs.org/package/htmlstrip-native" target="_blank" rel="external">htmlstrip-native</a> 来搞定这个问题。</p>
<p>测试后发现可以正确返回得到页面的链接，但是总结发出来却是乱码。感觉应该是包含了无效的 UTF-8 编码，遂尝试使用正则 <code>/\uFFFD/g</code> 替换掉无效的编码但是不起作用。试图移除最后一个字符也是无用。折腾了大约有 2 个小时，突然发现如果不去掉换行符则消息发出来是正常的。但是不去掉的话一行只有几个字啊… </p>
<p>不过还是有收获，仙子根据不移除换行符则消息正常判断是 IRC 消息长度限制导致了 UTF-8 流被截断。RFC 规定 IRC 消息长度为 512，但是一个 CJK 字符通常占 3 位。所以 512/3 差不多是 170。嘛很不爽的把消息限制改成了 144。这样发出来就不乱码了，但是总结大多比较长要连续发好几条消息导致游戏端被刷屏，玩家颇有微词。</p>
<p>后面就方便多了，加了一条 <code>&#39;p&#39;</code> 命令，意为 <code>play</code> 即 <del>玩坏</del>。在 <code>messages.js</code> 里设定了一个 Object 包含 2 个数组，对应命令消息和响应消息。程序中用 <code>async</code> 来实现命令匹配和回复，以及在没有找到可用命令时发送命令未知消息。还有一条 <code>&#39;c&#39;</code> 用来执行一些真正的命令——比如退出 <em>(:з」∠)</em></p>
<p>嘛现在这 <a href="https://github.com/phoenixlzx/nyaabot" target="_blank" rel="external">bot</a> 已经在群里开始调 (wan) 戏(huai)二小姐了 233</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-11T20:08:56.000Z"><a href="/2014/02/12/a-simple-wordpress-backup-script/">2014-02-12</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/12/a-simple-wordpress-backup-script/">一个简单的 WordPress 备份脚本</a></h1>
  

    </header>
    <div class="entry">
      
        <p> 居然会有人问我要这个东西… 我最不会写脚本了好吧呀！</p>
<p><del> 真心觉得这货 Google 一下粗来一大坨 </del></p>
<p> 嘛不多说了.. 既然写了就发粗来让大家吐槽一下好了… 不光是 WordPress.. 只要是静态文件 +MySQL 的站都可以用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line"><span class="comment"># settings</span></div><div class="line">mysqldbuser=<span class="string">"wordpress"</span></div><div class="line">mysqldbpass=<span class="string">"YourMySQLPassword"</span></div><div class="line">mysqldb=<span class="string">"wordpress"</span></div><div class="line">webroot=<span class="string">"/var/www/wordpress"</span></div><div class="line">backuproot=<span class="string">"/root/backup/backups"</span></div><div class="line">temproot=<span class="string">"/root/backup/temp/`date +%y-%m-%d`"</span></div><div class="line">temp=<span class="string">"/root/backup/temp"</span></div><div class="line">logfile=<span class="string">"/root/backup/backup.log"</span></div><div class="line"></div><div class="line">mkdir -p <span class="variable">$backuproot</span> <span class="variable">$temproot</span>/files</div><div class="line"></div><div class="line"><span class="comment"># backup start</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Backup start"</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"><span class="built_in">echo</span> $(date +<span class="string">"%y-%m-%d %H:%M:%S"</span>) &gt;&gt; <span class="variable">$logfile</span> </div><div class="line"><span class="built_in">echo</span> <span class="string">"------------"</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"></div><div class="line"><span class="comment"># database backup</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Dumping MySQL database..."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line">mysqldump --user=<span class="variable">$mysqldbuser</span> --password=<span class="variable">$mysqldbpass</span> --databases <span class="variable">$mysqldb</span> &gt; <span class="variable">$temproot</span>/db.$(date +<span class="string">"%y-%m-%d"</span>).sql</div><div class="line"><span class="built_in">echo</span> <span class="string">"Done exporting database."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"></div><div class="line"><span class="comment"># copy wordpress files</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Copying website files..."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line">cp -r <span class="variable">$webroot</span> <span class="variable">$temproot</span>/files/</div><div class="line"><span class="built_in">echo</span> <span class="string">"Done copying website files."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"></div><div class="line"><span class="comment"># Compress backup files</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Compressing backup files..."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">$temp</span></div><div class="line">tar zcf <span class="variable">$backuproot</span>/backup-$(date +<span class="string">"%y-%m-%d"</span>).tar.gz $(date +<span class="string">"%y-%m-%d"</span>) &gt;&gt; <span class="variable">$logfile</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Backup complete."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"></div><div class="line"><span class="comment"># Cleanup</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Cleaning up..."</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line">rm -rf <span class="variable">$temp</span>/* &gt;&gt; <span class="variable">$logfile</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"------------"</span> &gt;&gt; <span class="variable">$logfile</span></div><div class="line"><span class="built_in">echo</span> &gt;&gt; <span class="variable">$logfile</span></div></pre></td></tr></table></figure>

<p> 真心的没有用到任何… 高级的东西。</p>
<p> 保存为文件 <code>/root/backup.sh</code> 然后修改下前面几个变量，以 root 用户新建 cronjob</p>
<p><code>crontab -e</code> 然后敲 </p>
<p><code>00    01    *    *    1    /root/backup.sh</code></p>
<p> 保存。这样每周一的凌晨 1 点 (当然是你的服务器时间..) 就会自动备份到 <code>/root/backup/backups</code> 下。懒得写自动删除… 于是手动删好了。</p>
<p><del> 我要是被猫菊苣笑话了某人你可死定了 </del></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-11T17:45:36.000Z"><a href="/2014/02/12/custom-wallpaper-for-kdm-and-ksplash/">2014-02-12</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/12/custom-wallpaper-for-kdm-and-ksplash/">为 KDM 和 Ksplash 自定义壁纸</a></h1>
  

    </header>
    <div class="entry">
      
        <p>嘛非常简单的几个小步骤，不过 KDE 的 KDM 和启动屏幕不能直接自定义壁纸确实很讨厌。</p>
<h3 id="KDM">KDM</h3>
<p>表示 KDM 相对简单所以先说了。首先是下载对应的 KDM 主题，然后解压到一个临时目录下。</p>
<p>我下载的是 Glassified，在 <a href="http://kde-look.org/content/show.php/Glassified+Splash?content=84124" target="_blank" rel="external">kde-look</a> 上非常受欢迎的一款玻璃效果主题。</p>
<p>Glassified 主题解压后得到了 <code>background.svg</code> 和 <code>glassfied.xml</code> 等等文件。由于我的壁纸是 JPEG 格式而且本机没安装 Inkscape (放心 GIMP 不支持矢量图的…) 所以只好直接把图片切割并缩放为适合我屏幕分辨率的文件放进来，重命名为 <code>background.jpg</code>。因为文件变了，所以打开 <code>glassified.xml</code> 文件，查找 <code>background.svg</code> 并全部替换成 <code>background.jpg</code> <del>其实就替换了一处</del></p>
<p>接下来返回上级目录，把 <code>Glassified</code> 目录压缩为 <code>.tar.gz</code> 或 <code>.tar.bz2</code> 文件，就可以直接在 KDE 系统设置里安装了。(安装 KDM 主题需要 root 权限哦)</p>
<h3 id="KSplash">KSplash</h3>
<p>Ksplash 其实也不复杂，就是比较蛋疼的是目录很多，一般自己用的话… 我反正是把和我分辨率靠不着边的目录都删了。一样是下载的 Glassified 主题，解压后得到以分辨率命名的目录，扫了一眼居然没有 16:9 的分辨率啊啊啊啊！虽然我更喜欢 16:10 但是这也太蛋疼了吧！</p>
<p>在 <code>1600x1200</code> 这个目录里找到了所有的文件。其他目录里应该只有 <code>background.png</code> 或者类似的文件。于是进入 <code>1600x1200</code> 这个目录，用博丽灵梦的壁纸覆盖了 <code>background.png</code>。需要注意一点，本本是 16:9 1600×900 分辨率的 (嗯就是这么奇葩又正常的分辨率) 所以灵梦的壁纸原本是 1600x900，被我缩放成 1600x1200。图片看起来是被压窄了，不过放心——KDE 会自动帮你从 1600x1200 拉伸成适合屏幕分辨率的… 如果放的文件是 1600x900 或者其他 16:9 分辨率的话… <del> 效果非常鬼畜哦</del></p>
<p>留给自己用的，所以把其他分辨率的都删掉了。如果想要做来分享，那么还需要把图像文件放缩放成正确的比例和分辨率放在对应的目录下。完成后返回上级目录，像 KDM 主题一样压缩成 <code>.tar.gz</code> 即可。不需要 root 权限，可以直接在系统设置里安装。装好了记得测试下哦。</p>
<p>下面上效果图。</p>
<p><img src="http://blog.phoenixlzx.com/static/img/posts/2014-02-11-ksplash.jpg" alt="KSplash - Hakurei Reimu"></p>
<p>PS. Glassifed 这款主题的链接貌似死掉好久了。于是顺便附上下载链接好了。Dropbox 访问不能的话.. 嘛我相信大家都有办法的对吧～</p>
<ul>
<li><a href="https://dl.dropboxusercontent.com/u/2705405/Glassified.KDM.tar.gz" target="_blank" rel="external">Glassifed KDM</a></li>
<li><a href="https://dl.dropboxusercontent.com/u/2705405/Glassified.ksplash.tar.gz" target="_blank" rel="external">Glassifed KSplash</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-06T16:15:44.000Z"><a href="/2014/02/07/a-new-expjs-for-mypet-using-fastfibo/">2014-02-07</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/07/a-new-expjs-for-mypet-using-fastfibo/">基于斐波那契数列给 MyPet 写了新的 exp.js</a></h1>
  

    </header>
    <div class="entry">
      
        <p> 今天开始陆续得到玩家的反馈表示 MyPet 技能树坏掉了.. 不过 Hexadecimal 这次提交的技能树多了好多种，而且设定最高等级 100 级，确实很难写…或者说.. 写完了估计会累死什么的…</p>
<p> 所以更好的办法就是更改升级算法。MyPet 给出的 <a href="https://github.com/xXKeyleXx/MyPet/blob/master/experience-scripts/exp.js" target="_blank" rel="external">exp.js</a> 实在是让人看不懂，而且相当不好用。</p>
<p> 如果说有比较方便的递增数列，那么数得上斐波那契数列了吧～于是用斐波那契数列写了一个 exp.js。算法是从别处抄来的，<del> 反正是比递归快多了 </del></p>
<p> 特意加了 10 这样不会一开始的时候一下子升好几级。不过到 20 级之后升级就会相当困难了… </p>
<p> 文件 exp.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fibo exp.js by phoenixlzx</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculate</span><span class="params">(exp)</span> {</span></div><div class="line">    <span class="keyword">var</span> level = <span class="number">0</span>;</div><div class="line">    <span class="keyword">var</span> requiredExp = <span class="number">0</span>;</div><div class="line">    <span class="keyword">var</span> currentExp = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; <span class="built_in">Math</span>.floor(exp); i++) {</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">Math</span>.floor(exp) &lt;= fastfibo(i)) {</div><div class="line">		level = i;</div><div class="line">		requiredExp = fastfibo(level + <span class="number">1</span>);</div><div class="line">		currentExp = fastfibo(level);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	}</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Array</span>(level, requiredExp, currentExp);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fastfibo</span><span class="params">(n)</span> {</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> fibs = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line"></div><div class="line">    fibs.push(<span class="number">0</span>);</div><div class="line">    fibs.push(<span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= n; i++) {</div><div class="line">      fibs.push(fibs[<span class="number">0</span>] + fibs[<span class="number">1</span>]);</div><div class="line">      fibs.shift();</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> fibs[<span class="number">0</span>] + <span class="number">10</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//   |------------------|</span></div><div class="line"><span class="comment">//   |  Return Methods  |</span></div><div class="line"><span class="comment">//   |------------------|</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRequiredExp</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">    <span class="keyword">return</span> calculate(exp)[<span class="number">1</span>];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLevel</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">    <span class="keyword">return</span> calculate(exp)[<span class="number">0</span>];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentExp</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">    <span class="keyword">return</span> calculate(exp)[<span class="number">2</span>];</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getExpByLevel</span><span class="params">(level, mypet)</span> {</span></div><div class="line">    <span class="keyword">return</span> fastfibo(level);</div><div class="line">}</div></pre></td></tr></table></figure>

<p> 坑人之处在于，如果不按照这个格式来写，就会直接报错，类似 <code>Cannot convert null to int</code> 之类的。另外真心觉得 java 写的东西都渣爆了… 还是 java 这个语言渣爆了…以至于我不敢写 <code>var fibs = [0, 1]</code> 这样的语句我怕 rhino 不识别。</p>
<p> 不过我在管理组里发了这段 js 之后就被二小姐和静琴狠狠的鄙视了——原因，二小姐说：「你那程序会让 CPU 君愉快的死一死的喵～」</p>
<p> 所以再来贴静琴的 exp.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Copyright 2014 Jingqin Lynn</span></div><div class="line"><span class="comment">// MyPet exp.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> phi = (<span class="number">1</span> + <span class="built_in">Math</span>.sqrt(<span class="number">5</span>)) / <span class="number">2</span>;</div><div class="line"><span class="keyword">var</span> fib = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span> {</span></div><div class="line">  <span class="keyword">var</span> tmp = (<span class="built_in">Math</span>.pow(phi, n) - <span class="built_in">Math</span>.pow(<span class="number">1</span> - phi, n));</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.floor(tmp * <span class="built_in">Math</span>.sqrt(<span class="number">1</span> / <span class="number">5</span>)) | <span class="number">0</span>;</div><div class="line">};</div><div class="line"><span class="keyword">var</span> fibSum = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span> {</span></div><div class="line">  <span class="keyword">return</span> fib(n + <span class="number">2</span>) - <span class="number">1</span>;</div><div class="line">};</div><div class="line"><span class="keyword">var</span> fibPos = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span></div><div class="line">  <span class="keyword">var</span> tmp = (fn * <span class="built_in">Math</span>.sqrt(<span class="number">5</span>) + <span class="built_in">Math</span>.sqrt(<span class="number">5</span> * fn * fn + <span class="number">4</span>)) / <span class="number">2</span>;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.log(tmp) / <span class="built_in">Math</span>.log(phi)) | <span class="number">0</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLevel</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">  <span class="keyword">return</span> fibPos(exp + <span class="number">2</span>) - <span class="number">2</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRequiredExp</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">  <span class="keyword">return</span> getExpByLevel(getLevel(exp, mypet) + <span class="number">1</span>) - exp;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentExp</span><span class="params">(exp, mypet)</span> {</span></div><div class="line">  <span class="keyword">return</span> exp - getExpByLevel(getLevel(exp, mypet));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getExpByLevel</span><span class="params">(level, mypet)</span> {</span></div><div class="line">  <span class="keyword">return</span> fibSum(level) - <span class="number">1</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p> 连一段 exp.js 都带 copyright 真是龘龘的作风啊。</p>
<p> 咱真心不懂算法，从小学开始数学一直不及格，咋考上的大学也不知道。大学里教算法和数据结构的老师是学院里最水货老师之一，所以咱到现在也不知道所谓 O(n) 是个什么玩意儿。算法之类的书么怪咱自己笨，就是看不下去。也许咱根本就不适合做程序这条路吧。谁知道呢？我在这上面花费的时间已经太多了，多到我现在没有其他任何技能。否定了这一点，我真的就是废人一个了。</p>
<p> 嘛。抱怨到此为止。咱活这么大了一直被鄙视什么的还不是怪咱脑子笨，又不用功… 后面怎么走，只好努力加油了呗。暂时还不想变成废人的说。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-06T11:14:34.000Z"><a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/">2014-02-06</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/">Directshare - 一个简单的HTTP直链文件分享工具</a></h1>
  

    </header>
    <div class="entry">
      
        <p>嘛… 最近真心补番补多了智商降得有点厉害.. 直到我发现自己已经看不懂别人的 js 代码，却还会手贱点开 bilibili 之后才 <a href="https://plus.google.com/107142103119739092775/posts/M2LA33yfdRG" target="_blank" rel="external"> 立下军令状</a>，再不开新坑再不敲代码就敲不出来啦！</p>
<p>一直很纠结再写点啥。之前财务管理系统的坑估计要弃，因为实在一个人填不完…然后 NAE 一直没计划好，估计这个坑会更巨。之前 luke 酱说发现了一个不错的东方音乐站，想要个桌面端。咱之前有试着学 Qt 但是一直没有方便的文档而且.. 终归是咱能力不行吧，Qt 估计是一时半会搞不定了。写桌面端的话，似乎只有 node-webkit 了.. 然后看了一下午的文档只有一个感觉——我要死了。</p>
<p><del>Intel 开发的东西和红帽一样蛋疼</del></p>
<p>桌面端什么的…. 所以就放着吧… 随便搞个东西练练手算了。想想看还没有练习过文件上传 <del>真丢人啊都不会写文件上传</del> 于是来写一个上传文件并分享的东西好了 w</p>
<p>于是老样子.. <code>express -e</code> 新建一个项目模板，初始化 git 仓库… 诶似乎有什么东西不对？</p>
<p><code>express.bodyParser()</code> 没了…</p>
<p>先不管这些，基本的路由和功能堆起来，打印出结果来看看能不能正确获取文件信息。然后… 当然失败了。</p>
<p>没有 <code>bodyParser</code> 之后，带有文件上传的表单无法被处理了，<code>req.files</code> 是 <code>undefined</code>，<code>req.body</code> 里也是空的..</p>
<p>一阵 Google 之后表示，泥煤的 express 3.4.x 又改了… <code>bodyParser</code> 已经被 <a href="https://groups.google.com/forum/#!topic/express-js/iP2VyhkypHo" target="_blank" rel="external"> 弃用 </a>，原因是存在<a href="http://andrewkelley.me/post/do-not-use-bodyparser-with-express-js.html" target="_blank" rel="external"> 可能占满磁盘的漏洞</a>。目前推荐的方式是直接使用 <code>multiparty</code>。于是又去翻这货的文档，表示要蛋疼许多… 纠结了一会觉得还是先用回 3.3.4 之后慢慢折腾下 multiparty。</p>
<p>Directshare 使用 HTTP 直链文件，看起来似乎有点危险，不过毕竟可以拿来做图床、临时的文件共享或者在没有 FTP/SSH 的情况下把文件上传到服务器什么的.. 最重要的是，<del>我只是想练练手而已搞那么复杂干嘛..</del></p>
<p>基本思路：整个程序分为负责接收文件的 master 和负责分发文件的 cluster。客户端使用浏览器 POST 方法上传文件 =&gt; master 得到文件后计算 SHA256 并把文件从临时目录移动到保存文件的目录，文件名是 SHA256 值，不带有后缀。接下来通知所有 cluster 来拖。这里要有一个验证，暂且用 POST accesskey 之类的东西来做好了。因为似乎没找到啥能通过 http 同步的 node 包，所以简单的双向 POST 数据基本上也没问题。本来想在 cluster 接收到文件后再计算一次 hash 值.. 不过这个后面再说。通知所有 cluster 用了一个 forEach，虽然是阻塞的方法不过发几个 post 请求应该是相当快的。接下来把从 cluster 下载文件的地址返回给客户端浏览器。这个时候 cluster 应该已经收到 post 请求，过来拖文件了。</p>
<p>文件 <code>master.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</div><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, config.port || <span class="number">3000</span>);</div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(express.favicon());</div><div class="line">app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.bodyParser({</div><div class="line">    keepExtensions: <span class="literal">false</span>,</div><div class="line">    uploadDir: <span class="string">"tmpdata"</span></div><div class="line">}));</div><div class="line">app.use(express.methodOverride());</div><div class="line"><span class="comment">// app.use(app.router);</span></div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.render(<span class="string">'index'</span>, {</div><div class="line">        siteName: config.siteName</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="comment">// console.log(req.files.uploadfile);</span></div><div class="line"></div><div class="line">    <span class="comment">// hash file with sha256</span></div><div class="line">    <span class="keyword">var</span> sha256sum = crypto.createHash(<span class="string">'sha256'</span>);</div><div class="line">    <span class="keyword">var</span> filehash = fs.ReadStream(req.files.uploadfile.path);</div><div class="line">    filehash.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span></div><div class="line">        sha256sum.update(d);</div><div class="line">    });</div><div class="line">    filehash.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">        <span class="keyword">var</span> d = sha256sum.digest(<span class="string">'hex'</span>);</div><div class="line">        console.log(d + <span class="string">''</span> + req.files.uploadfile.name);</div><div class="line">        <span class="comment">// move file to storage location</span></div><div class="line">        fs.rename(req.files.uploadfile.path, <span class="string">'files/'</span> + d, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">            <span class="comment">// notify clusters to fetch file</span></div><div class="line">            config.clusters.forEach(<span class="function"><span class="keyword">function</span><span class="params">(cluster)</span> {</span></div><div class="line">                <span class="keyword">var</span> post_data = querystring.stringify({</div><div class="line">                    clusterkey: config.clusterkey,</div><div class="line">                    filename: req.files.uploadfile.name,</div><div class="line">                    filehash: d</div><div class="line">                });</div><div class="line"></div><div class="line">                <span class="keyword">var</span> post_options = {</div><div class="line">                    hostname: cluster,</div><div class="line">                    port: config.clustersport,</div><div class="line">                    path: <span class="string">'/syncfile'</span>,</div><div class="line">                    method: <span class="string">'POST'</span>,</div><div class="line">                    headers: {</div><div class="line">                        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</div><div class="line">                        <span class="string">'Content-Length'</span>: post_data.length</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// Set up the request</span></div><div class="line">                console.log(<span class="string">'syncing with '</span> + cluster);</div><div class="line">                <span class="keyword">var</span> post_req = http.request(post_options);</div><div class="line"></div><div class="line">                <span class="comment">// post the data</span></div><div class="line">                post_req.write(post_data);</div><div class="line">                post_req.end();</div><div class="line">            });</div><div class="line">            <span class="comment">// return client with download path</span></div><div class="line">            res.send(<span class="number">200</span>, config.clusterurl + d);</div><div class="line">        });</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/syncfile'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) {</div><div class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        res.sendfile(<span class="string">'files/'</span> + req.body.filehash);</div><div class="line">    }</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// handle 404</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.send(<span class="number">404</span>, <span class="string">'My files gone?! :-O'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port '</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p>然后是 <code>cluster.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, config.port || <span class="number">3000</span>);</div><div class="line">app.use(express.favicon());app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.methodOverride());</div><div class="line">app.use(express.bodyParser());</div><div class="line">app.use(app.router);</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.send(<span class="number">400</span>, <span class="string">'Bad request'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">app.get(<span class="string">'/:hash'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    fs.readFile(<span class="string">'files/'</span> + req.params.hash + <span class="string">'.json'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, filedata)</span> {</span></div><div class="line">        <span class="keyword">if</span> (err) {</div><div class="line">            <span class="keyword">if</span> (err.code === <span class="string">'ENOENT'</span>) {</div><div class="line">                res.send(<span class="number">404</span>, <span class="string">'File not found. :-('</span>);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                console.log(err);</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="keyword">var</span> filedata = <span class="built_in">JSON</span>.parse(filedata);</div><div class="line">            res.download(<span class="string">'files/'</span> + req.params.hash, filedata.filename);</div><div class="line">        }</div><div class="line">    })</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/syncfile'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) {</div><div class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        res.send(<span class="number">200</span>);</div><div class="line">        <span class="keyword">var</span> post_data = querystring.stringify({</div><div class="line">            clusterkey: config.clusterkey,</div><div class="line">            filehash: req.body.filehash</div><div class="line">        });</div><div class="line"></div><div class="line">        <span class="keyword">var</span> post_options = {</div><div class="line">            hostname: config.master,</div><div class="line">            port: config.masterport,</div><div class="line">            path: <span class="string">'/syncfile'</span>,</div><div class="line">            method: <span class="string">'POST'</span>,</div><div class="line">            headers: {</div><div class="line">                <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</div><div class="line">                <span class="string">'Content-Length'</span>: post_data.length</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Set up the request</span></div><div class="line">        console.log(<span class="string">'Getting file with SHA256'</span> + req.body.filehash);</div><div class="line">        <span class="keyword">var</span> post_req = http.request(post_options, <span class="function"><span class="keyword">function</span><span class="params">(res)</span> {</span></div><div class="line">            <span class="keyword">var</span> file = fs.createWriteStream(<span class="string">'files/'</span> + req.body.filehash);</div><div class="line">            res.pipe(file);</div><div class="line">        });</div><div class="line"></div><div class="line">        <span class="comment">// post the data</span></div><div class="line">        post_req.write(post_data);</div><div class="line">        post_req.end();</div><div class="line"></div><div class="line">        fs.appendFile(<span class="string">'files/'</span> + req.body.filehash + <span class="string">'.json'</span>, <span class="built_in">JSON</span>.stringify({</div><div class="line">            <span class="string">"filename"</span>: req.body.filename</div><div class="line">        }), <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">            console.log(<span class="string">'Saved file'</span> + req.body.filename + <span class="string">'with hash'</span> + req.body.filehash);</div><div class="line">        });</div><div class="line">    }</div><div class="line"></div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port'</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这样程序应该就相当清晰了。在 cluster 端使用了 SHA256 值作为文件名的 json 作为文件信息存储，当前只保存了对应的文件名。至于重复文件啊什么的.. 暂时没想好怎么做，不过拿 sha256 做文件名本来就有这个功能的想法。本地测试完成，commit #<a href="https://github.com/phoenixlzx/directshare/commit/f6365cfcbd18536f226da1e4fe633ece665b6ec2" target="_blank" rel="external"><code>f6365cfcbd</code></a></p>
<p>当我发军令状的时候是昨晚 9 点，第一个可用版本提交是今天 2 点左右，5 个小时开新坑再填上… 不过这坑有点小所以好填… 所以 5 个小时不算什么了吧就… 嘛至少不用改名 BAKA 了～</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-02T11:55:02.000Z"><a href="/2014/02/02/respond-for-aaaa-queries-when-ipv4-exists-rather-than-ipv6/">2014-02-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/02/respond-for-aaaa-queries-when-ipv4-exists-rather-than-ipv6/">IPv4 存在而 IPv6 不存在时对于 AAAA 记录查询的响应</a></h1>
  

    </header>
    <div class="entry">
      
        <p>昨天收到了仙子酱 forward 给我的来自 prosody 开发者的回复，关于 Google 无法连接到 <code>talk.archlinuxcn.org</code> 的问题。开发者指出是 DNS 响应不规范，在 IPv4 存在而 IPv6 不存在时，如果首先查询 <code>AAAA</code> 记录而得到了 <code>NXDOMAIN</code>，则会停止继续查询记录。</p>
<p>根据 <a href="http://www.ietf.org/rfc/rfc4074.txt" target="_blank" rel="external">RFC 4074</a>，在 IPv4 存在而 IPv6 不存在时，对于 <code>AAAA</code> 记录的响应 RCODE 应为<code>0</code>，即 <code>NOERROR</code> 而不是 <code>NXDOMAIN</code>。</p>
<p>根据 RFC 的说明对略萌 DNS 的程序做了部分修改，commit #<a href="https://github.com/phoenixlzx/minimoedns/commit/a5a81172d5b4ab0fee375a70b7065883ff0fbc97" target="_blank" rel="external"><code>a5a81172d5</code></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">connection.query(<span class="string">'SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND (`type` ="A"OR `type` ="AAAA"OR `type` ="CNAME")'</span>,</div><div class="line">    name,</div><div class="line">    <span class="function"><span class="keyword">function</span><span class="params">(err, result)</span> {</span></div><div class="line">      <span class="keyword">if</span> (err) {</div><div class="line">	  ...</div></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">result.forEach(<span class="function"><span class="keyword">function</span><span class="params">(record)</span> {</span></div><div class="line">    <span class="keyword">switch</span> (record.type) {</div><div class="line">	<span class="keyword">case</span> <span class="string">"A"</span>: </div><div class="line">	<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="string">"AAAA"</span>:</div><div class="line">	...</div></pre></td></tr></table></figure>

<p>一个简单的改动，没做什么测试就提交了。然后发现 Google DNS 等缓存 DNS 给 <code>AAAA</code> 查询返回了<code>SERVFAIL</code>…</p>
<p><code>dig +trace</code> 查了下发现死循环了… 再去看 RFC 同时用猫的 NS 服务器做了测试，发现对于这种情况，返回的记录是 Authority 部分 SOA，其他全部是空，格式和 <code>NXDOMAIN</code> 一样，只不过 RCODE 是 <code>NOERROR</code> 而已。</p>
<p>嘛。commit #<a href="https://github.com/phoenixlzx/minimoedns/commit/5f50bbaa89ac7b51259aeaaa54b08d65476300da" target="_blank" rel="external"><code>5f50bbaa89</code></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">"A"</span>:</div><div class="line">    <span class="keyword">var</span> content = SOAresult[<span class="number">0</span>].content.split(<span class="string">""</span>);</div><div class="line">    response.authority.push(dns.SOA({</div><div class="line">	name: SOAresult[<span class="number">0</span>].name,</div><div class="line">	primary: content[<span class="number">0</span>],</div><div class="line">	admin: content[<span class="number">1</span>].replace(<span class="string">"@"</span>, <span class="string">"."</span>),</div><div class="line">	serial: content[<span class="number">2</span>],</div><div class="line">	refresh: content[<span class="number">3</span>],</div><div class="line">	retry: content[<span class="number">4</span>],</div><div class="line">	expiration: content[<span class="number">5</span>],</div><div class="line">	minimum: content[<span class="number">6</span>],</div><div class="line">	ttl: SOAresult[<span class="number">0</span>].ttl||config.defaultTTL</div><div class="line">    }));</div><div class="line">    response.header.rcode = consts.NAME_TO_RCODE.NOERROR;</div><div class="line">    <span class="keyword">return</span> response.send();</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure>

<p>然后发现把 <code>case &quot;A&quot;</code> 写到前面不对… 然后把这段改到了 <code>case &quot;AAAA&quot;</code> 和 <code>case &quot;CNAME&quot;</code> 后面，另外在 MySQL 模块中也做了修改，防止在有 IPv6 时返回 IPv4。咱基本不会写 SQL 于是做了两步查询。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">exports.queryAAAA = <span class="function"><span class="keyword">function</span><span class="params">(name, callback)</span> {</span></div><div class="line">    pool.getConnection(<span class="function"><span class="keyword">function</span><span class="params">(err, connection)</span> {</span></div><div class="line">        <span class="keyword">if</span> (err) {</div><div class="line">            console.log(err.message);</div><div class="line">        }</div><div class="line">        connection.query(<span class="string">'SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND (`type` ="AAAA"OR `type` ="CNAME")'</span>,</div><div class="line">            name,</div><div class="line">            <span class="function"><span class="keyword">function</span><span class="params">(err, result)</span> {</span></div><div class="line">                <span class="keyword">if</span> (err) {</div><div class="line">                    connection.release();</div><div class="line">                    <span class="keyword">return</span> callback(err, <span class="literal">null</span>);</div><div class="line">                }</div><div class="line">                <span class="keyword">if</span> (result[<span class="number">0</span>]) {</div><div class="line">                    connection.release();</div><div class="line">                    callback(<span class="literal">null</span>, result);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    connection.query(<span class="string">'SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND `type` ="A"'</span>,</div><div class="line">                        name,</div><div class="line">                        <span class="function"><span class="keyword">function</span><span class="params">(err, resultA)</span> {</span></div><div class="line">                            <span class="keyword">if</span> (err) {</div><div class="line">                                connection.release();</div><div class="line">                                <span class="keyword">return</span> callback(err, <span class="literal">null</span>);</div><div class="line">                            }</div><div class="line">                            connection.release();</div><div class="line">                            callback(<span class="literal">null</span>, resultA);</div><div class="line">                        });</div><div class="line">                }</div><div class="line">            });</div><div class="line">    });</div><div class="line">}</div></pre></td></tr></table></figure>

<p>看起来处理的有点 ugly 不过咱才疏学浅只好先这样了。 commit 之后所有略萌 DNS 节点更新，于是再次查询就正常了 w</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">~&gt; dig <span class="at_rule">@<span class="number">8.8</span>.<span class="number">8.8</span><span class="preprocessor"> talk.archlinuxcn.org</span><span class="preprocessor"> AAAA</span></span></div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; DiG 9<span class="class">.9</span><span class="class">.2-P2</span> &lt;&lt;&gt;&gt; <span class="at_rule">@<span class="number">8.8</span>.<span class="number">8.8</span><span class="preprocessor"> talk.archlinuxcn.org</span><span class="preprocessor"> AAAA</span></span></div><div class="line">; (1 server found)</div><div class="line">;; global options<span class="value">: +cmd</span></div><div class="line">;; Got answer<span class="value">:</span></div><div class="line">;; -&gt;&gt;<span class="tag">HEADER</span>&lt;&lt;- opcode<span class="value">: QUERY, status: NOERROR, id: <span class="number">26181</span></span></div><div class="line">;; flags<span class="value">: qr rd ra;</span> QUERY<span class="value">: <span class="number">1</span>, ANSWER: <span class="number">0</span>, AUTHORITY: <span class="number">1</span>, ADDITIONAL: <span class="number">1</span></span></div><div class="line"></div><div class="line">;; OPT PSEUDOSECTION<span class="value">:</span></div><div class="line">; EDNS<span class="value">: version: <span class="number">0</span>, flags:;</span> udp<span class="value">: <span class="number">512</span></span></div><div class="line">;; QUESTION <span class="tag">SECTION</span><span class="value">:</span></div><div class="line">;talk<span class="class">.archlinuxcn</span><span class="class">.org</span>.          IN      AAAA</div><div class="line"></div><div class="line">;; AUTHORITY <span class="tag">SECTION</span><span class="value">:</span></div><div class="line">archlinuxcn.org.        <span class="number">1800</span>    IN      SOA     ns1.moedns.net. admin.moedns.com. <span class="number">1391266676</span> <span class="number">3600</span> <span class="number">360</span> <span class="number">1209600</span> <span class="number">180</span></div><div class="line"></div><div class="line">;; Query <span class="tag">time</span><span class="value">: <span class="number">224</span> msec</span></div><div class="line">;; SERVER<span class="value">: <span class="number">8.8</span>.<span class="number">8.8</span><span class="hexcolor">#53</span>(<span class="number">8.8</span>.<span class="number">8.8</span>)</span></div><div class="line">;; WHEN<span class="value">: Sun Feb  <span class="number">2</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">18</span> <span class="number">2014</span></span></div><div class="line">;; MSG SIZE  rcvd<span class="value">: <span class="number">115</span></span></div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-01T00:37:34.000Z"><a href="/2014/02/01/simple-steps-with-ubuntu-server/">2014-02-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/01/simple-steps-with-ubuntu-server/">Ubuntu 服务器配置简易指南</a></h1>
  

    </header>
    <div class="entry">
      
        <p>之前许诺过的… 虽然像装系统一样纯体力活，靠的是经验，没啥技术含量。不过既然答应了，写出来也算是自己 Note 一下。</p>
<p>本文所有操作均在 Ubuntu 12.04 LTS Server 下测试通过(需要 root 权限)。或者说，已经在无数个 Ubuntu 12.04 LTS Server 下使用过了… Debian 的话，应该大差不差，有些包可能没有或者名称不一样，需要适当做调整。</p>
<p><strong>注意：如果未声明「新建文件」则只修改对应的行，并非整个配置文件内容。请使用查找功能查找对应变量或语句来完成修改。</strong></p>
<h3 id="Step_1-_SSH_基本配置">Step 1. SSH 基本配置</h3>
<p>不管是独立服务器还是 VPS，SSH 都是远程管理利器。一般 VPS 是通过操作系统模板安装，默认允许 root 帐号登录。独立服务器如果是手动安装的系统，大部分情况下禁用了 root 帐号登录。首先我们要配置使用公钥登录，并且在尽可能的情况下禁用 root 登录和密码登录。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 创建 RSA 密钥对 (本地)</span></div><div class="line">ssh-keygen -t rsa</div></pre></td></tr></table></figure>

<p>这个过程中会需要你填写一些基本信息，照样例填写即可。完成后会在 <code>~/.ssh</code> 目录下生成 <code>id_rsa</code> 文件和 <code>id_rsa.pub</code> 文件(生成文件时用默认文件路径和文件名的话)。前者是私钥，也就是无论如何都不能让第二个人知道的东西；后者是公钥，一般来讲，只要你不让 Jeff Dean 看到，你可以把它满大街扔。</p>
<p>得到服务器 root 或带有管理员权限(sudo) 帐号的密码后，使用 <code>ssh-copy-id</code> 来传输公钥。</p>
<p>根据 ssh-copy-id 的 <a href="http://linux.die.net/man/1/ssh-copy-id" target="_blank" rel="external"> 手册</a>，命令格式如下。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 发送公钥到服务器，这里服务器 IP 为 192.168.1.102</span></div><div class="line"><span class="preprocessor"># 格式： ssh-copy-id [-i [identity_file]] [user@]machine </span></div><div class="line">ssh-copy-id -i ~/<span class="preprocessor">.ssh</span>/id_rsa<span class="preprocessor">.pub</span> root<span class="localvars">@192</span><span class="number">.168</span><span class="number">.1</span><span class="number">.102</span></div></pre></td></tr></table></figure>

<p>如果是第一次连接该服务器(大部分情况是这样)，ssh 会询问是否接受服务器指纹。一般来说如果服务器指纹改变则有可能你遇到了中间人攻击(比如你连接的服务器不是你的而是一个蜜罐等，使用 IP 而不是域名可以一定程度上避免该问题，但是如果有路由级劫持的话，那就不好说了。但是一般来讲，在私人网络里遇到路由级劫持的情况也只有天朝的 ISP 才干的出来。)，此时应停止继续连接，检查网络后再尝试。不过还有另一种情况：重装系统后指纹也会变掉。</p>
<p>确定没问题后敲 <code>yes</code> 来继续连接，接下来会询问帐号的密码。输入正确密码即可将公钥保存到服务器的正确位置。抑或你可以用更笨一点的方法，首先尝试 ssh 连接服务器并用密码登录，然后手动执行命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 保存公钥</span></div><div class="line">mkdir -p ~/.ssh</div><div class="line"><span class="built_in">echo</span> <span class="string">'your_public_key_here'</span> &gt; ~/.ssh/authorized_keys</div><div class="line">chmod <span class="number">0700</span> ~/.ssh && chmod <span class="number">0600</span> ~/.ssh/authorized_keys</div></pre></td></tr></table></figure>

<p><code>authorized_keys</code> 文件权限不正确的话是不会生效的哦。公钥保存到服务器上之后可以新开一个 ssh session 尝试连接服务器，如果密钥没有密码保护的话，应该直接就进去了。确保配置正确，再退出服务器， <strong>尤其是禁用密码登录后应在结束最后一个 session 前检查是否可以正确登录服务器</strong> ，不然退出来之后很可能别想再连上去了…</p>
<p>在进行接下来的任何操作之前，都要保证这些操作不能被中断。在天朝这种奇葩的网络中，ssh 不被中断除非你是用内网，而且就算你内网也说不定，因为没准哪个装了数字公司家产品的内网机器就会给你来个 ARP 攻击啊什么的把你的 ssh 断掉。<del>甚至把你整个网络搞瘫痪</del></p>
<p>于是—— <a href="http://tmux.sourceforge.net/" target="_blank" rel="external">Tmux</a> 登场！</p>
<p>可以首先看一下 Tmux 的 <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tmux&amp;sektion=1" target="_blank" rel="external"> 手册</a> 或者简单使用的话掌握如下几个操作：</p>
<ul>
<li><code>tmux</code> # 启动新的 Tmux session</li>
<li><code>tmux attach</code> # 连接到已存在的 Tmux session</li>
</ul>
<p>在 Tmux 中，默认的组合键是 <code>CTRL+B</code>，配合其他键盘命令：</p>
<ul>
<li><code>^B+D</code> # 断开当前 session，session 中的程序将会继续运行</li>
<li><code>^B+C</code> # 创建新的 console，在一个 console 正在执行任务时可以创建一个新的来执行其他任务。</li>
<li><code>^B+[Number]</code> # 切换到对应的 console，比如 <code>^B+1</code> 切换到 ID 为 1 的 console</li>
</ul>
<p>有了 tmux 之后，即使 ssh 断掉，也可以重新连接并使用 <code>tmux attach</code> 来恢复工作(也有很多其他类似的替代，比如 screen/byobu 等)。于是现在新建一个 tmux session 并开始后续配置步骤。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 新建 tmux session</span></div><div class="line">tmux</div><div class="line"><span class="preprocessor"># 安装 sshguard 防止 ssh 暴力破解</span></div><div class="line">apt-<span class="keyword">get</span> install sshguard</div></pre></td></tr></table></figure>

<p>类似 sshguard 的还有 fail2ban 等。</p>
<p>如果使用的是 VPS 的话，最重要的——不要忘记更改密码。命令：<code>passwd</code></p>
<h3 id="Step_2-_LNMP">Step 2. LNMP</h3>
<p>很多童鞋买了 VPS 什么的就为了跑一个 WordPress，然后听信传言说什么 LAMP 啊之类的… 我的亲身体会是，在你有足够大的内存之前，Apache 这个东西真的不要碰… 就算我开一台 4GB 内存的 VPS 一样会因为各种原因(包括内存不足) Apache 莫名挂掉。</p>
<p>安装 LNMP 命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt<span class="attribute">-get</span> install php5<span class="attribute">-cgi</span> php5<span class="attribute">-mysql</span> php5<span class="attribute">-fpm</span> php5<span class="attribute">-curl</span> php5<span class="attribute">-gd</span> php5<span class="attribute">-idn</span> php<span class="attribute">-pear</span> php5<span class="attribute">-imap</span> php5<span class="attribute">-mcrypt</span> php5<span class="attribute">-mhash</span> php5<span class="attribute">-pspell</span> php5<span class="attribute">-recode</span> php5<span class="attribute">-snmp</span> php5<span class="attribute">-sqlite</span> php5<span class="attribute">-tidy</span> php5<span class="attribute">-xmlrpc</span> php5<span class="attribute">-xsl</span> nginx mysql<span class="attribute">-server</span></div></pre></td></tr></table></figure>

<p>看起来很长… 其实这一条就基本啥都搞定了的说(</p>
<p>另外推荐安装 PHP 字节码加速器 XCache，之前折腾 memcached 的时候被猫菊苣吐槽说这货速度不够快于是果断受诱导换了 XCache… 然后确实比 memcached 快多了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 安装 XCache</span></div><div class="line">apt-<span class="keyword">get</span> install php5-xcache</div></pre></td></tr></table></figure>

<h4 id="配置_PHP">配置 PHP</h4>
<p>文件 <code>/etc/php5/fpm/php.ini</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改最大上传大小为 10M，两个位置，一个 upload_max_filesize 一个 post_max_size</span></div><div class="line"><span class="constant">upload_max_filesize</span> = 10M</div><div class="line"><span class="constant">post_max_size</span> = 10M</div><div class="line"><span class="comment"># 修改最大内存使用，默认是 128M，如果你内存较多又是专门跑 PHP 的可以适当加大，具体数值建议做压力测试。</span></div><div class="line"><span class="constant">memory_limit</span> = 128M</div><div class="line"><span class="comment"># 修改最大执行时间，默认 30，同样如果是跑 PHP 的服务器可以适当加大。</span></div><div class="line"><span class="constant">max_execution_time</span> = 30</div></pre></td></tr></table></figure>

<p>文件 <code>/etc/php5/fpm/pool.d/www.conf</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 修改侦听路径为 UNIX socket</span></div><div class="line">listen = /<span class="keyword">var</span>/run/php5-fpm.sock</div><div class="line"><span class="preprocessor"># 修改 process manager 最大请求数量限制以防服务器挂掉，默认该语句被注释掉(应该是不限制？) 一般 VPS 直接取消注释即可。</span></div><div class="line">pm.max_requests = <span class="number">500</span></div></pre></td></tr></table></figure>

<h4 id="配置_NGINX">配置 NGINX</h4>
<p>文件 <code>/etc/nginx/nginx.conf</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改 NGINX 进程数量，根据 CPU 核心数而定</span></div><div class="line">worker_processes <span class="number">4</span>;</div><div class="line"><span class="comment"># events 部分，修改 NGINX 进程连接数，同时打开多线程(默认被注释，取消注释即可)</span></div><div class="line">worker_connections <span class="number">1024</span>;</div><div class="line">multi_accept <span class="function_start"><span class="keyword">on</span></span>;</div><div class="line"><span class="comment"># http 部分，关闭服务器版本号(默认被注释，取消注释即可)</span></div><div class="line">server_tokens off;</div><div class="line"><span class="comment"># 打开 GZIP 减少数据量，会稍微增加 CPU 负担。这些语句直接取消注释即可。</span></div><div class="line">gzip <span class="function_start"><span class="keyword">on</span></span>;</div><div class="line">gzip_disable <span class="string">"msie6"</span>;</div><div class="line">gzip_vary <span class="function_start"><span class="keyword">on</span></span>;</div><div class="line">gzip_proxied any;</div><div class="line">gzip_comp_level <span class="number">6</span>;</div><div class="line">gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</div><div class="line">gzip_http_version <span class="number">1.1</span>;</div><div class="line">gzip_types <span class="type">text</span>/plain <span class="type">text</span>/css <span class="type">application</span>/json <span class="type">application</span>/x-javascript <span class="type">text</span>/xml <span class="type">application</span>/xml <span class="type">application</span>/xml+rss <span class="type">text</span>/javascript;</div></pre></td></tr></table></figure>

<h4 id="安装_Postfix">安装 Postfix</h4>
<p>如果你需要让该服务器上任何程序发邮件的话，除非使用外部 SMTP 服务器，否则需要一个程序来提供 Sendmail</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-<span class="keyword">get</span> install postfix</div></pre></td></tr></table></figure>

<p>安装过程中会询问 Postfix 的工作环境，这里选择「Internet site」，然后填写自己的域名地址。</p>
<h3 id="Step_3-_安装_WordPress">Step 3. 安装 WordPress</h3>
<p><strong>这里用 WordPress 作为一个样例，其他基于 PHP+MySQL 的网站程序同理。</strong></p>
<p>下载最新的简体中文版 WordPress 程序到服务器网站路径(当前版本 3.8.1，网站目录为 /var/www，也可以使用其他较为安全的目录)，并为站点文件设置正确的权限。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="title">cd</span> /var/www</div><div class="line"><span class="title">wget</span> -c http://cn.wordpress.org/wordpress-<span class="number">3.8</span><span class="number">.1</span>-zh_CN.tar.gz</div><div class="line"><span class="title">tar</span> zxfv wordpress-<span class="number">3.8</span><span class="number">.1</span>-zh_CN.tar.gz</div><div class="line"><span class="preprocessor"># 解包后网站目录即是 /var/www/wordpress</span></div><div class="line"><span class="title">rm</span> wordpress-<span class="number">3.8</span><span class="number">.1</span>-zh_CN.tar.gz</div><div class="line"><span class="title">chown</span> -<span class="type">R</span> www-<span class="typedef"><span class="keyword">data</span>:www-<span class="keyword">data</span> .</span></div><div class="line"><span class="title">find</span> . -<span class="typedef"><span class="keyword">type</span> f -exec chmod 644 <span class="container">{}</span> \;</span></div><div class="line"><span class="title">find</span> . -<span class="typedef"><span class="keyword">type</span> d -exec chmod 755 <span class="container">{}</span> \;</span></div></pre></td></tr></table></figure>

<p>新建站点配置文件 <code>/etc/nginx/sites-available/wordpress.conf</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">server {</div><div class="line">	<span class="preprocessor"># 默认侦听所有 IPv4 地址，如果需要同时侦听 IPv4+IPv6 则添加：</span></div><div class="line">	<span class="preprocessor"># listen [::]:80;</span></div><div class="line">        server_name example<span class="preprocessor">.com</span> www<span class="preprocessor">.example</span><span class="preprocessor">.com</span><span class="comment">;</span></div><div class="line">        <span class="preprocessor"># 如果是二级域名则是</span></div><div class="line">        <span class="preprocessor"># server_name suddomain.example.com</span></div><div class="line"></div><div class="line">	access_log   /var/log/nginx/example<span class="preprocessor">.com</span><span class="preprocessor">.access</span><span class="preprocessor">.log</span><span class="comment">;</span></div><div class="line">	error_log    /var/log/nginx/example<span class="preprocessor">.com</span><span class="preprocessor">.error</span><span class="preprocessor">.log</span><span class="comment">;</span></div><div class="line"></div><div class="line">        root /var/www/wordpress<span class="comment">;</span></div><div class="line">        index index<span class="preprocessor">.php</span><span class="comment">;</span></div><div class="line"></div><div class="line">        location / {</div><div class="line">                try_files $uri $uri/ /index<span class="preprocessor">.php</span>?$args<span class="comment">; </span></div><div class="line">        }</div><div class="line"></div><div class="line">        location ~ \<span class="preprocessor">.php</span>$ {</div><div class="line">                try_files $uri =<span class="number">404</span><span class="comment">;</span></div><div class="line">                include fastcgi_params<span class="comment">;</span></div><div class="line">                fastcgi_pass unix:/var/run/php5-fpm<span class="preprocessor">.sock</span><span class="comment">;</span></div><div class="line">        }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>保存，把配置文件链接到 NGINX 的网站配置目录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ln <span class="attribute">-s</span> /etc/nginx/sites<span class="attribute">-available</span>/wordpress<span class="built_in">.</span>conf /etc/nginx/sites<span class="attribute">-enabled</span><span class="subst">/</span></div></pre></td></tr></table></figure>

<p>重启 NGINX</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service nginx restart</div></pre></td></tr></table></figure>

<p><strong>注意</strong> 如果是较新的 NGINX 版本，要同时侦听 IPv4 和 IPv6，需要在默认服务器配置，一般来说是在 <code>/etc/nginx/sites-enabled/default</code> 这个文件中定义的(其实就是 listen 后面带有 default_server 的站点配置文件)，<code>listen</code> 部分改为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen <span class="attr_selector">[::]</span><span class="value">:<span class="number">80</span> default_server ipv6only=off;</span></div></pre></td></tr></table></figure>

<p>其他站点配置的 <code>listen</code> 部分仍为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">listen</span> <span class="attr_selector">[::]</span><span class="pseudo">:80</span>;</div></pre></td></tr></table></figure>

<p>即可。</p>
<p>连接数据库，为网站程序新建数据库和用户。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql <span class="attribute">-u</span> root <span class="attribute">-p</span></div></pre></td></tr></table></figure>

<p>这会向你索要 root 密码。在安装过程中， MySQL 的 root 密码应该已经被正确设置。接下来新建用户和数据库。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 新建数据库</div><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">database</span> <span class="string">`wordpress`</span>;</span></div><div class="line"># 新建用户</div><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">`wordpress`</span> identified <span class="keyword">by</span> <span class="string">'YourStrongPassWordHereLoL'</span>;</span></div><div class="line"># 赋予权限</div><div class="line"><span class="operator"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> wordpress.* <span class="keyword">to</span> wordpress@localhost identified <span class="keyword">by</span> <span class="string">'YourStrongPassWordHereLoL'</span>;</span></div><div class="line"># 刷新权限表</div><div class="line">flush privileges;</div><div class="line"># 退出</div><div class="line">exit</div></pre></td></tr></table></figure>

<p>这样我们就得到了一个数据库名为 <code>wordpress</code>，以及一个拥有权限的用户 <code>wordpress</code> 及其密码 <code>YourStrongPassWordHereLoL</code>。</p>
<p>此时如果你的域名已经正确配置并解析，访问你的域名将看到 WordPress 的安装向导。使用上面的数据库连接信息即可完成安装。</p>
<h3 id="Step_4-_配置_Node-js">Step 4. 配置 Node.js</h3>
<p>Node.js 越来越火爆了。咱也是 Node.js developer (作死自大一回..) 不过对于更多用户来讲，Node.js 的吸引力在于大量方便的 Web 应用。<del>比如末影袜</del></p>
<p>Ubuntu 12.04 的 Node 版本还是 0.6.x 真是不能忍。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># 安装 Git 以及其他必须的组件</span></div><div class="line">apt-<span class="keyword">get</span> install git build-essential zlib1g-dev</div><div class="line"><span class="preprocessor"># 安装 n</span></div><div class="line">git clone https:<span class="comment">//github.com/visionmedia/n.git</span></div><div class="line">cd n && make</div><div class="line"><span class="preprocessor"># 安装最新版 Node.js，当前为 0.10.25</span></div><div class="line">n <span class="number">0.10</span><span class="number">.25</span></div></pre></td></tr></table></figure>

<p>然后 Node.js 环境就部署完毕啦。简单吧？</p>
<p>安装一个 Node 应用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="keyword">install</span> -g shadowsocks</div></pre></td></tr></table></figure>

<p>干啥的我就不多说了。嗯。 <code>-g</code> 表示全局安装，会安装到 <code>/usr/lib/node_modules</code> 下作为可执行程序。</p>
<h3 id="完">完</h3>
<p>暂时写这么多。想起来会继续更新下。</p>
<p>部分内容来源：</p>
<ul>
<li><a href="http://felixc.at/" target="_blank" rel="external">Felix Wiki</a> - 有猫菊苣这个 Wiki 在真是干啥都方便啊啊哈哈哈哈。</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-31T00:00:00.000Z"><a href="/2014/01/31/2014-01-31/">2014-01-31</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/31/2014-01-31/">2014-01-31</a></h1>
  

    </header>
    <div class="entry">
      
        <p>于是又到了新年，貌似我的年终总结还没写(啊咧？</p>
<p><del>于是这篇就是为了应付作业憋出来的</del></p>
<p>今天.. 哦不，昨天开始收各种 ACG 向的图片了。G+ 上发图的不少，所以我暂时还不用去翻 Pixiv 什么的。作为一只二次元的喵星人，硬盘里没点宅文化算什么呢喵？</p>
<p>似乎最近几天不少人在折腾 KDE。由来不清楚，总之就是有人问了关于 KDE 的问题，于是我在 G+ 上发了一些 KDE 的截图、录屏以及一些配置什么的。慢慢发现周围越来越多的人开始问，「用 xxx 环境好换 KDE 不呢？」，「KDE 能做这个么能做那个么？」，「这么多包怎么选呢？」… 等等的问题。作为 KDE 简体中文翻译组的成员(又来了(σ≧∀≦)σ﻿) 能帮到别人还是非常欢心的嗯。</p>
<p>这么一来二去的自己也想开始折腾了 www。KDE 的玻璃特效和二次元的风格是绝配哦～<a href="http://dimpurr.com" target="_blank" rel="external">钉子 </a> 说，「二次元向的主题就是萌妹子 + 半透明 + 光晕」，对此我深信不疑。今天.. 啊昨天翻了半天找到几张还算满意的壁纸，深色壁纸真心看过头了，想要点淡色清新的 w 结果发 G+ 之后无辜的 <a href="http://nya.io" target="_blank" rel="external">Bob 酱</a> 被各种 mention 2333</p>
<p><img src="http://blog.phoenixlzx.com/static/img/posts/2014-01-31-desktop-1.jpg" alt="yua"></p>
<p>随后翻 Zerochan 发现了一张很有味道的东方壁纸～</p>
<p><img src="http://blog.phoenixlzx.com/static/img/posts/2014-01-31-desktop-2.jpg" alt="Hakurei Reimu"></p>
<p>嗯决定就是这张了 w 顺便去掉了一直放在左侧隐藏的面板，把快速启动的程序丢到桌面目录里。一个是快速启动不像以前那样可以自动居中了(或者说我忘记怎么设置了…) 再一个选择文本的时候容易把那个该死的面板激活弹出来… 这样桌面不显得空，而且玻璃特效、Plasma 控件位置都和壁纸相当贴合～</p>
<p>晚上照例是不看春晚的 w 和大家一起疯狂玩 Minecraft。去年还准备了 <a href="http://www.tudou.com/programs/view/-O34AbY1ZmQ/" target="_blank" rel="external"> 焰火晚会 </a>，今年似乎很多 op 都回家不方便上线了，于是就没准备什么活动。虽然 <del> 红包肯定少不了的 QAQ 我足足发了 1600 个节操啊…</del> 1.7 版开始 Minecraft 变得特别大，因为有了很多新的背景音乐。我倒是挺喜欢原来的那些音乐，新版音乐虽然也有味道但是一个人玩的时候太恐怖了(ಥ_ಥ)。所以一直是关掉音乐，带着耳机 loop 境界の比方的 OST。最喜欢的是「約束の絆」和「Judgment じゃ!」。前者是补番的时候发现这插曲相当好听，以至于在 OST 发售之前就在萌购上预定了，拿到手之后一直在 loop。后者是扫盘发到 u2 上，有人反馈这首音轨抓取有错误，我才去重新听的。说实话那时候我只听了「約束の絆」，因为好听到不想听其他的了。后来校正的时候发现「Judgment じゃ!」也很好听，爱酱的声音完全变了啊！超级带感的说。专辑里还有其他一些音乐，听的时候会莫名难过，也许是第一次看完境界の彼方的时候哭了一晚上？</p>
<p>前段时间又看了「のんのんびより」，真是越来越羡慕在日本的乡村生活了… 顺便说一句，「のんのんびより」的 OP 和 ED 也非常好听哦～(｢･ω･)｢</p>
<p><del>啊我去终于算是快憋完了</del></p>
<p>每次都是罗嗦一大堆没用的东西.. 别看咱现在写作苦手，<del>咱小时候的作文还是上过报纸的</del>。现在代码敲多了，技术文档读多了，动漫看多了，越来越多的习惯于用简短的英语或日语来描述事物、动作或感情…汉语的使用能力已经比壕桥好不哪去了…壕桥的错别字连天估计我也不知道还能对他 233 到什么时候。——比如上句话你听懂了么？</p>
<p>嘛。日子总是这么一天天的过，在这里给大家拜新年的说～</p>
<p><img src="http://blog.phoenixlzx.com/static/img/posts/2014-01-31-pixiv40813042.jpg" alt="HAPPY SPRING FESTIVAL"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
    <a href="/archives/" class="alignleft prev">上一页</a>
  
  
    <a href="/archives/page/3/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.phoenixlzx.com">
  </form>
</div>

  <div class="widget tag">
    <h3 class="title">关于</h3>
    <div class="entry">
        <img src="/static/img/avatar/avatar.jpg" style="margin: auto; width: 100%;"/>
        <h4 style="text-align: center">Phoenix Nemo (phoenixlzx)</h4>
        <div style="margin: auto; text-align: center;">
            <a href="https://plus.google.com/107142103119739092775" target="_blank"><i class="fa fa-google-plus fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://twitter.com/phoenixlzx" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://github.com/phoenixlzx" target="_blank"><i class="fa fa-github fa-2x"></i></a>&nbsp;&nbsp;
            <a class="fancybox" href="#emailme"><i class="fa fa-envelope-o fa-2x"></i></a>
        </div>
        <div style="display: none;">
            <div id="emailme">
                <p><strong>个人邮箱地址</strong></p>
                <br/>
                <code>echo 'aUBwaG9lbml4bHp4LmNvbQo='|base64 --decode</code>
            </div>
        </div>
    </div>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Algorithm/">Algorithm</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>5</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>2</small></li>
  
    <li><a href="/categories/Network/">Network</a><small>3</small></li>
  
    <li><a href="/categories/Nodejs/">Node.js</a><small>5</small></li>
  
    <li><a href="/categories/Notes/">Notes</a><small>8</small></li>
  
    <li><a href="/categories/Practise/">Practise</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Algorithm/" style="font-size: 10.00px;">Algorithm</a><a href="/tags/Anime/" style="font-size: 16.00px;">Anime</a><a href="/tags/Artwork/" style="font-size: 10.00px;">Artwork</a><a href="/tags/Configuration/" style="font-size: 12.00px;">Configuration</a><a href="/tags/DKMS/" style="font-size: 10.00px;">DKMS</a><a href="/tags/DNS/" style="font-size: 14.00px;">DNS</a><a href="/tags/FFmpeg/" style="font-size: 14.00px;">FFmpeg</a><a href="/tags/Fibonacci/" style="font-size: 10.00px;">Fibonacci</a><a href="/tags/Filesystem/" style="font-size: 10.00px;">Filesystem</a><a href="/tags/ImageMagick/" style="font-size: 10.00px;">ImageMagick</a><a href="/tags/KDE/" style="font-size: 10.00px;">KDE</a><a href="/tags/Kernel/" style="font-size: 10.00px;">Kernel</a><a href="/tags/Linux/" style="font-size: 14.00px;">Linux</a><a href="/tags/Minecraft/" style="font-size: 12.00px;">Minecraft</a><a href="/tags/MongoDB/" style="font-size: 10.00px;">MongoDB</a><a href="/tags/Multimedia/" style="font-size: 14.00px;">Multimedia</a><a href="/tags/MyPet/" style="font-size: 10.00px;">MyPet</a><a href="/tags/Network/" style="font-size: 14.00px;">Network</a><a href="/tags/Nodejs/" style="font-size: 20.00px;">Node.js</a><a href="/tags/Practise/" style="font-size: 10.00px;">Practise</a><a href="/tags/Script/" style="font-size: 10.00px;">Script</a><a href="/tags/Server/" style="font-size: 18.00px;">Server</a><a href="/tags/Ubuntu/" style="font-size: 14.00px;">Ubuntu</a><a href="/tags/VPN/" style="font-size: 10.00px;">VPN</a><a href="/tags/WordPress/" style="font-size: 10.00px;">WordPress</a><a href="/tags/iptables/" style="font-size: 12.00px;">iptables</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2014/09/03/2014-natsu/">2014·夏</a>
      </li>
    
      <li>
        <a href="/2014/07/21/setup-openconnect-server-on-ubuntu/">在 Ubuntu 服务器上搭建 OpenConnect 服务器小记</a>
      </li>
    
      <li>
        <a href="/2014/05/24/iptables-rate-limiting-rules-to-block-dns-amplification-attack/">使用 iptables 过滤 DNS 放大攻击</a>
      </li>
    
      <li>
        <a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">在异步方法中使用 for 循环，以及循环中包含异步方法的几点坑</a>
      </li>
    
      <li>
        <a href="/2014/05/17/repo-arm-disk-rescue-and-resize/">修复 Arch Rollback Machine 磁盘占用</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Phoenix Nemo
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'phoenixhexo';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js?https';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>