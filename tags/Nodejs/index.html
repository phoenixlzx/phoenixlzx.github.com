<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Node.js | Phoenix&#39;s island</title>
    <meta name="author" content="Phoenix Nemo">
    
    <meta name="description" content="Phoenix&#39;s Blog">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <meta property="og:site_name" content="Phoenix&#39;s island"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link href="/favicon.png" rel="icon">
    <link rel="alternate" href="/atom.xml" title="Phoenix&#39;s island" type="application/atom+xml">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.css"/>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Phoenix&#39;s island</a></h1>
  <h2><a href="/">Sun will shine on the horizon.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/links">Links</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title tag">Node.js</h2>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-19T03:18:20.000Z"><a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">2014-05-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">在异步方法中使用 for 循环，以及循环中包含异步方法的几点坑</a></h1>
  

    </header>
    <div class="entry">
      
        <p>又是熬夜干活。</p>
<p>之前在 StackOverflow 上看到过 <a href="http://stackoverflow.com/questions/5050265/javascript-nodejs-is-array-foreach-asynchronous" target="_blank" rel="external">Array.forEach 是同步 (阻塞) 的</a>，但是实际使用的时候，特别是我在写 Node.js 程序的时候几乎没感觉到过它的阻塞—— forEach 或者其他 for 循环之后的 callback 从来都是被立即调用，没有等待整个循环执行完。&lt;== 这个命题是个假命题，下面会说明。</p>
<p>今天又一次掉进异步的坑里才发现 for 循环确实是阻塞的。至于为何它后面的回调函数会立即被调用，原因是 for 循环里有异步方法。整个循环不会等待异步方法结束，而是直接进入下一个循环，所以它 <strong>看起来</strong> 像是异步的，后面的回调函数「立即」被调用了。<a href="http://stackoverflow.com/questions/21184340/async-for-loop-in-node-js" target="_blank" rel="external">StackOverflow</a> 上有更详细的例子和说明。</p>
<p>不过如果是数组，那么直接使用 <a href="https://github.com/caolan/async" target="_blank" rel="external">async</a> 替代原生的 forEach 和其他 for 语句即可简单解决。但是问题出在我这里的情况是要用 <code>for in</code> 语句处理 Object，虽说 Javascript 里 Object 和 Array 非常相似但是毕竟没有 Array 那些好用的方法，在这种情况下也不方便使用 prototype 来给我的 object 新增类似方法。二小姐给出的解决方案是手动设置计数器，获得 object 长度的办法是使用 <code>Object.keys(obj).length</code>。</p>
<p><strong>注意</strong> <code>Object.keys(obj).length</code> 并不一定是要循环的次数，具体需要看 Object 的结构。我这里就是解析 DOM 得到的 Object 所以有额外的东西，<code>length - 3</code> 才是需要的结果。</p>
<p>代码写出来大概是这个样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(obj, callback)</span> {</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> tasks = <span class="built_in">Object</span>.keys(obj).length;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> arr = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {</div><div class="line">	</div><div class="line">	tasks--;</div><div class="line">	</div><div class="line">	async.eachSeries(arr, someFunc(n, cb) {</div><div class="line">	</div><div class="line">	    <span class="comment">// do stuff here.</span></div><div class="line">	    </div><div class="line">	    cb();</div><div class="line">	</div><div class="line">	}, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line">	</div><div class="line">	    <span class="comment">// operations after array iteration completed.</span></div><div class="line">	    </div><div class="line">	    <span class="keyword">if</span> (tasks === <span class="number">0</span>) {</div><div class="line">	    </div><div class="line">		<span class="comment">// All tasks done, return to callback</span></div><div class="line">		<span class="keyword">return</span> callback();</div><div class="line">	    </div><div class="line">	    }</div><div class="line">	    </div><div class="line">	});</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>判断的语句其实也可以放在 <code>async.eachSeries</code> 之后，这样可以明显减少判断的计算 (虽然那点计算不算啥) 但是也有可能会在没等待最后一次 async 执行结束的时候就返回了，所以保险起见还是多花点处理器来保证全部任务执行完。以及在最后 <code>callback</code> 的时候如果不写 <code>return</code> 就会失效。我还没查原因，因为已经累得不行了… 所以(当回伸手党) 如果哪位童鞋知道的麻烦告知… 有灵梦的节操相送哦 &gt;///&lt;</p>
<p>==== 2014-05-20 更新 ====</p>
<p>感谢 Xuetian Weng 菊苣为了灵梦的节操不远万里给我纠错 /w\ 上面的代码在 <code>async.eachSeries</code> 里有异步方法时存在多次 <code>tasks === 0</code> 的情况，因为同样的因为 <code>for in</code> 循环不会等待 async 结束，async 的回调不一定会在 <code>tasks</code> 下一次自减之前被调用。解决办法是 <code>tasks--</code> 放在 <code>async.eachSeries</code> 的回调函数里。更好些的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span><span class="params">(obj, callback)</span> {</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> tasks = <span class="built_in">Object</span>.keys(obj).length;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> arr = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {</div><div class="line"></div><div class="line">        async.eachSeries(arr, someFunc(n, cb) {</div><div class="line"></div><div class="line">            <span class="comment">// do stuff here.</span></div><div class="line"></div><div class="line">            cb();</div><div class="line"></div><div class="line">        }, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line"></div><div class="line">            <span class="comment">// operations after array iteration completed.</span></div><div class="line">	    </div><div class="line">            <span class="comment">// tasks self-decrease should be here to ensure every async.eachSeries call has ended.</span></div><div class="line">            tasks--;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (tasks === <span class="number">0</span>) {</div><div class="line"></div><div class="line">                <span class="comment">// All tasks done, return to callback</span></div><div class="line">                <span class="keyword">return</span> callback();</div><div class="line"></div><div class="line">            }</div><div class="line"></div><div class="line">        });</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>不过菊苣说最后的 return 是可有可无，我这里的测试是不加 return (不管是在前面还是后面) 这个 callback 都不会被正确调用… 所以 return 的问题并没有算是解决，于是放到后面有时间的话来满满折腾吧~ 看 Xuetian Weng 菊苣如此渴求节操的表情咱就给一点表示感谢好了呜(双手奉上</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-05-07T11:46:09.000Z"><a href="/2014/05/07/new-njlug-homepage/">2014-05-07</a></time>
      
      
  
    <h1 class="title"><a href="/2014/05/07/new-njlug-homepage/">新的 NJLUG 主站</a></h1>
  

    </header>
    <div class="entry">
      
        <p>南京 Linux 用户组有一段时间没有聚会了。偶然想起来之前我用 Jekyll 折腾的那个主页，随手敲了主页地址… 啊啦，还基本上没变啊…</p>
<p>嘛虽然自己写了那么几个东西，不过在组里待了也有一段时间也学到了不少东西。用户对社区的回报应该就在这时候展现出来吧。</p>
<p>依旧是 Express.js 框架，依旧是 Bootstrap。不过这回不想用数据库了，改用文本存储。除了主页和关于，顺便集成一个 Planet 在里面。RSS feed 的话，除了遍历一遍 upsert (不存在的添加，已存在的跳过)之外没想到什么更好的办法。实际上本来就是 RSS 没必要存储所有的文章，更何况又不是做之前想做的类似 Google Reader 的东西。</p>
<p>目前的 Planet 工作方式为首先检测是否存在文章数据文件 <code>posts.array</code>，如果不存在则读取 <code>planet.list</code> 中的订阅链接，获取到文章后 push 到一个数组中，按照发表日期排序并保存在 <code>posts.array</code> 里。到底是先排序再保存还是先存进去，渲染页面的时候再排序，这个稍微纠结了下。因为自己的配置文件里更新频率是 1 hour, 而且似乎每次更新到的文章数量还挺多的。所以保存时排序的话，则每天固定排序 23 次；如果渲染时排序的话，就看每天能有几个访问了…. 然后发现自己在这种小问题上纠结个毛毛啊啊啊啊啊。</p>
<p>排序后保存进文件之前和从文件读出之后要有两个 JSON 操作。保存之前 <code>JSON.stringify(posts)</code> 转换成字符串再保存，否则文件里是 <code>[[object Object], [object Object]]</code>。读出来之后 <code>JSON.parse(posts)</code> 再转换成对象数组，否则直接就一字符串没办法处理。</p>
<p>接下来就是主页和关于。因为不想写用户系统了所以就不发文章了吧… 关于可以是万年不变的页面，首页的话，显示最近的公告好了。最简单的实现就是存两个 markdown 文件然后用 marked 渲染出来插在页面里。</p>
<p>全部的源码在 <a href="https://github.com/phoenixlzx/NJLUG-site" target="_blank" rel="external"> 这里</a>。</p>
<p>目前似乎域名还没解析，田华兄也未必决定用这个.. 所以效果的话戳 <a href="http://njlug.phoenixlzx.com" target="_blank" rel="external"> 这里 </a> 看。</p>
<p>然后顺便说一句.. 现在已经健忘到我已经忘记刚刚想起来要写的东西了<em>(:з」∠)</em></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-04-28T12:53:55.000Z"><a href="/2014/04/28/sublive-live-subtitle-for-local-players/">2014-04-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/04/28/sublive-live-subtitle-for-local-players/">SubLive: 本地播放器的弹幕 API 服务器</a></h1>
  

    </header>
    <div class="entry">
      
        <p>昨晚 KNA 群里在讨论给本地播放器加弹幕功能。之前虽然听说过但是并未接触过所谓「弹幕池」的概念，但是星光菊苣说只要生成 SSA 字幕直接交给播放器挂上就成。并且，(虽然很想顺带吐槽 Zht 和我们争了半天最后槽点根本不在一个点子上 orz) 少将也表示时效并不重要，不需要考虑播放器的字幕自动重载问题。</p>
<p>所以躺在床上的时候就考虑了下整体的架构。还是最拿手的 HTTP RESTful API，基本功能的话就是获取字幕和发送弹幕。大致的思路如下。</p>
<ul>
<li>客户端打开媒体文件后首先获得文件的 hash。有些播放器自动寻找字幕似乎是通过文件名.. 这样的话我改个名字岂不是彻底失效。不过用 hash 来做检索文件的唯一信息的话，不同压制组放出的同一部片源都会有不同的弹幕… 不过似乎也好，如果压制了字幕进去的话，有些针对字幕君的吐槽啊什么的.. 嘛于是就这样。</li>
<li>服务端通过文件 hash 值来查找有无已存在的字幕文件。如果找到则直接发送文件给客户端，如果没有则在数据库中创建该条目，并生成新的字幕文件发送给客户端。</li>
<li>客户端以约定好的数据格式发送弹幕信息。用户友好啊之类的(所见即所得什么的..) 就都是客户端的问题了.. 服务端拿到的应该是处理好的数据。</li>
<li>服务端接收到新的弹幕后将其存进数据库，并追加到已有字幕文件。这样下次其他客户端再次请求该文件的时候就会看到弹幕。</li>
</ul>
<p>…</p>
<p>剩下的就不知道了，因为上面几条出来之后我就睡着了 zzzzZ</p>
<p>…</p>
<p>早上翘课写代码这种事情早就习以为常了… 更何况是 (我已经不知道该如何吐槽) 的老师的上机课….</p>
<p>基本架构和功能大概 3 小时搞定，之前大概花了将近 1 个小时看 <a href="http://matroska.org/technical/specs/subtitles/ssa.html" target="_blank" rel="external">SSA/ASS Subtitles</a> 以及 Express 4.x 的文档。因为 <a href="https://github.com/visionmedia/express#quick-start" target="_blank" rel="external">Express 4.x 开始命令行工具被单独分开</a>，害我半天没找到生成模板的命令… (你丫瞎改啥啊啊啊啊</p>
<p>编码过程里倒是没遇到啥坑，就是数据处理有点烦。因为没找到啥比较好的 SSA 字幕处理库，生成的时候都是手动处理，各种 <code>+ &#39;\n&#39;</code> 什么的..</p>
<p>以及，SSA/ASS 字幕的格式特性让 <code>Array.prototype.join</code> 得以利用，省掉不少麻烦。</p>
<p>于是源码在 <a href="https://github.com/phoenixlzx/sublive" target="_blank" rel="external"> 这里</a>。在基础架构之上还可以很方便的添加大量其他功能，验证啊什么的.. 顺便我还木有做 POST 数据的检查。这个大概晚些时候会加上。</p>
<p>四月的荒废状态持续了 27 天宣告结束。嘛，挣脱五月病要感谢星光菊苣、Zht、少将以及 KNA 字幕组的所有小伙伴们 &gt;///&lt; 感谢你们～</p>
<p>以后要继续加油喵！～</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-22T13:05:43.000Z"><a href="/2014/03/22/chinese-word-split-search-with-mongodb/">2014-03-22</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/22/chinese-word-split-search-with-mongodb/">MongoDB 中文分字搜索</a></h1>
  

    </header>
    <div class="entry">
      
        <p>为工作室开发的 <a href="http://idoc.nuister.org" target="_blank" rel="external">iDocument</a> 文档分享平台，因为后端数据库是 MongoDB 所以没有做站内搜索，只是放了个百度站内搜索的工具。不过后来发现 BAKA 百度根本不收录站内链接，所以主席强烈要求做站内搜索<em>(:з」∠)</em></p>
<p>MongoDB 的分词搜索不支持中文，而精确匹配的话基本上就没啥意义了。所以考虑一下几种方法。</p>
<ul>
<li>同义词匹配，高端的玩不转，初步想法是为每个文档对象添加一个 <code>tag</code> 来做搜索关键字，例如「高等数学」的文档可以有「高数」这个 tag，搜索「高等数学」和「高数」都能得到这个文档。</li>
<li>分字匹配，可能会有少许误差，但是对于程序开发和网站运营人员来说都能减轻负担，因为不需要手动维护 tag 了。</li>
</ul>
<p>考虑到数据库中已经有之前的一些数据 (以及主席表示上传文档实在太累了所以强烈要求我保留原数据) 所以这里选择了分字搜索方式。</p>
<p>按照喵菊给的方法，基本的步骤如下</p>
<ol>
<li>分字函数名称为 <code>split()</code>，文档标题为 <code>title</code>，搜索字段为 <code>querytext</code>。</li>
<li>存入新的文档对象时，包含一个 attribute 名为 <code>searchIndex</code>，值为 <code>split(title)</code>。也就是将 <code>title</code> 分字后得到的数组。</li>
<li>将 <code>searchIndex</code> 编入索引。<code>ensureIndex({searchIndex: 1})</code>，顺序的话，喵菊之前提到过，但是这里暂不考虑。</li>
<li>搜索时把 <code>split(querytext)</code> 交给数据库来 <code>find()</code></li>
</ol>
<p>由于 Javascript 自带一个超级好用的 <code>String.prototype.split()</code> 方法，所以分字就是 <code>title.split(&#39;&#39;)</code>。</p>
<p>以及，喵菊说如果用数组的话就不能用 <code>/variable/i</code> 这样的正则来忽略大小写了。所以存进去新 index 的时候要全部转换成小写，搜索的时候也要转换成小写来实现 Case-insensitive search.</p>
<p>修改路由函数，添加一个新的属性 <code>searchIndex</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> newdoc = {</div><div class="line">    title: req.body.title,</div><div class="line">    updateTime: <span class="built_in">Math</span>.round((<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() / <span class="number">1000</span>),</div><div class="line">    fileType: req.body.fileType,</div><div class="line">    belongs: req.body.belongs,</div><div class="line">    course: req.body.courseId,</div><div class="line">    type: req.body.type,</div><div class="line">    link: req.body.link,</div><div class="line">    downloads: <span class="number">0</span>,</div><div class="line">    searchIndex: req.body.title.toLowerCase().split(<span class="string">''</span>).clean(<span class="string">" "</span>) <span class="comment">// Remove space element after split to single text.</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="built_in">Array</span>.prototype.clean = <span class="function"><span class="keyword">function</span> <span class="params">(deleteValue)</span> {</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>[i] == deleteValue) {</div><div class="line">            <span class="keyword">this</span>.splice(i, <span class="number">1</span>);</div><div class="line">            i--;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">};</div></pre></td></tr></table></figure>

<p>修改文档模型函数，添加时将 <code>searchIndex</code> 编入索引：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">exports.addnew = <span class="function"><span class="keyword">function</span><span class="params">(newdoc, callback)</span> {</span></div><div class="line">    collection.insert(newdoc, {safe: <span class="literal">true</span>}, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line">        <span class="keyword">if</span> (err) {</div><div class="line">            <span class="keyword">return</span> callback(err);</div><div class="line">        }</div><div class="line">        collection.ensureIndex({</div><div class="line">            searchIndex: <span class="number">1</span></div><div class="line">        }, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span></div><div class="line">            <span class="keyword">if</span> (err) {</div><div class="line">                <span class="keyword">return</span> callback(err);</div><div class="line">            }</div><div class="line">            callback(<span class="literal">null</span>);</div><div class="line">        });</div><div class="line">    });</div><div class="line">}</div></pre></td></tr></table></figure>

<p>新建文档搜索函数。 <strong>坑：如果直接把分好字的数组交给数据库来 find 那么一样是精确匹配的效果。这里应该是我对 MongoDB 还不够熟悉才掉坑里…</strong></p>
<p>正确的匹配方法是 <code>db.documents.find({searchIndex: {$all: splittedTextArray} })</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">exports.searchdoc = <span class="function"><span class="keyword">function</span><span class="params">(splittedTextArray, callback)</span> {</span></div><div class="line">    collection.find({</div><div class="line">        searchIndex: {$all: splittedTextArray}</div><div class="line">    })</div><div class="line">        .sort({downloads: -<span class="number">1</span> })</div><div class="line">        .toArray(<span class="function"><span class="keyword">function</span><span class="params">(err, docs)</span> {</span></div><div class="line">            <span class="keyword">if</span> (err) {</div><div class="line">                <span class="keyword">return</span> callback(err, <span class="literal">null</span>);</div><div class="line">            }</div><div class="line">            callback(<span class="literal">null</span>, docs);</div><div class="line">        });</div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后按照主席的要求，写了个脚本来更新之前的数据。方法是将原来的数据全部取出，然后遍历写回的同时添加 <code>searchIndex</code>。看了下原来有的数据大约就 100 多条，所以直接全部取了没考虑分段的问题嗯。</p>
<p>据喵菊说，数组处理是 MongoDB 的强项所以非常快～</p>
<p>整个项目的源码在 <a href="https://github.com/DuoHuoStudio/iDocument" target="_blank" rel="external"> 这里</a></p>
<p>修改完毕，测试效果非常赞 w 不过就是 BAKA 的 blueed 还没写搜索列表页的样式就是了… <del>据说前端苦逼</del></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-17T19:49:22.000Z"><a href="/2014/02/18/file-upload-with-expressjs-and-formidable/">2014-02-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/18/file-upload-with-expressjs-and-formidable/">使用 Express.js 和 Formidable 上传文件</a></h1>
  

    </header>
    <div class="entry">
      
        <p> 写 <a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/"> 之前一篇文章 </a> 时发现 Express.js 更新到 3.4.x 了，运行的时候出现警告 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">connect</span>.multipart() will be removed in <span class="keyword">connect</span> <span class="number">3.0</span></div><div class="line">visit https:<span class="regexp">//github</span>.com/senchalabs/<span class="keyword">connect</span>/wiki/Connect-<span class="number">3.0</span> <span class="keyword">for</span> alternatives</div><div class="line"><span class="keyword">connect</span>.limit() will be removed in <span class="keyword">connect</span> <span class="number">3.0</span></div></pre></td></tr></table></figure>

<p> 按照 Wiki 的指引看了下 <code>multiparty</code>，<code>connect-multiparty</code> 和 <code>formidable</code>，最终选用了 <code>formidable</code> <del> 因为说明看起来很碉堡的样子 </del></p>
<p> 简单写了两个路由控制，按照 <a href="https://github.com/felixge/node-formidable" target="_blank" rel="external">node-formidable</a> 的示例加上了打印文件上传信息的几个语句，运行时发现程序 hang 了…</p>
<p>Google 许久无果——找到的结果基本都是要你注释掉 <code>app.use(express.bodyParser())</code>，而我已经是 express 3.4 所以早就没有 bodyParser 了。回去又看 formidable 给的例子，于是发现自己犯二了…——</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/upload"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span></div></pre></td></tr></table></figure>

<p> 真是个バカ！</p>
<p> 立马给 <code>index.ejs</code> 中的 form 部分加上了 <code>enctype=&quot;multipart/form-data&quot;</code>，重试，成功。 <del> 于是就这么解决了 </del>(被打飞 </p>
<p> 主程序 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</div><div class="line"><span class="keyword">var</span> formidable = <span class="built_in">require</span>(<span class="string">'formidable'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(express.favicon());</div><div class="line">app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.urlencoded());</div><div class="line">app.use(express.methodOverride());</div><div class="line">app.use(app.router);</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.render(<span class="string">'index'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/upload'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">var</span> form = <span class="keyword">new</span> formidable.IncomingForm();</div><div class="line"></div><div class="line">    form.parse(req, <span class="function"><span class="keyword">function</span><span class="params">(err, fields, files)</span> {</span></div><div class="line">        res.writeHead(<span class="number">200</span>, {<span class="string">'content-type'</span>: <span class="string">'text/plain'</span>});</div><div class="line">        res.write(<span class="string">'received upload:\n\n'</span>);</div><div class="line">        res.end(util.inspect({fields: fields, files: files}));</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port'</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p> 以及一个简单的 <code>index.ejs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Upload test<span class="tag">&lt;/<span class="title">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">href</span>=<span class="value">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>Test formidable<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"/upload"</span> <span class="attribute">method</span>=<span class="value">"post"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"textfield"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">name</span>=<span class="value">"file"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">button</span> <span class="attribute">type</span>=<span class="value">"submit"</span>&gt;</span>Upload<span class="tag">&lt;/<span class="title">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></div></pre></td></tr></table></figure>

<p>PS. <a href="http://stackoverflow.com/a/5543851" target="_blank" rel="external"> 后来发现确实有人遇到这个问题了…</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-16T19:19:34.000Z"><a href="/2014/02/17/nyaabot-bot-for-nyaacat-irc/">2014-02-17</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/17/nyaabot-bot-for-nyaacat-irc/">Nyaabot: 为喵窝服务器构建的 IRC 机器人</a></h1>
  

    </header>
    <div class="entry">
      
        <p>第一次写 IRC 机器人。之前已经看到仙子酱等等菊苣们写了好多种 IRC 机器人，但是都是 Python 写的。倒不是歧视 Python 啊什么的… 主要是咱服务器上木有方便的环境跑，而且也有需要自己做的功能。正好在逛 NPM 的时候发现了 <a href="https://npmjs.org/node-irc" target="_blank" rel="external">node-irc</a> 这个包，于是折腾一下午搞出来一个机器人程序。</p>
<p>目前主要纠结的问题是 IRC 没有类似 HTTP Status code 或者类似的指示代码，所以我能想到的处理办法就是验证字符串。好吧我承认这种方法很不靠谱，但是… 各种求靠谱方法啊…</p>
<h3 id="客户端配置">客户端配置</h3>
<p>专门写了一个 <code>config.js</code> 来保存客户端的配置。根据 <a href="https://node-irc.readthedocs.org/en/latest/index.html" target="_blank" rel="external">node-irc 的文档</a>，在程序中做如下参数设定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">serveroptions: {</div><div class="line">    userName: <span class="string">'nyaabot'</span>,</div><div class="line">    realName: <span class="string">'Nyaacat IRC Bot'</span>,</div><div class="line">    port: <span class="number">7000</span>,</div><div class="line">    debug: <span class="literal">false</span>,</div><div class="line">    showErrors: <span class="literal">false</span>,</div><div class="line">    autoRejoin: <span class="literal">true</span>,</div><div class="line">    autoConnect: <span class="literal">true</span>,</div><div class="line">    channels: [<span class="string">'#nyaacat'</span>],</div><div class="line">    secure: <span class="literal">true</span>,</div><div class="line">    selfSigned: <span class="literal">false</span>,</div><div class="line">    certExpired: <span class="literal">false</span>,</div><div class="line">    floodProtection: <span class="literal">true</span>,</div><div class="line">    floodProtectionDelay: <span class="number">1000</span>,</div><div class="line">    sasl: <span class="literal">false</span>,</div><div class="line">    stripColors: <span class="literal">true</span>,</div><div class="line">    channelPrefixes: <span class="string">"&#"</span>,</div><div class="line">    messageSplit: <span class="number">512</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>看起来都是很好懂的嗯。昨天在配置 CraftIRC 插件的时候撞到一个坑，NickServ 一直报错说参数不完整。调了半天发现是这里的 <code>realName</code> 部分没有填写，于是这次特地写上了注释要求该项必须填写。</p>
<h3 id="帐户验证">帐户验证</h3>
<p>之后发现木有类似验证帐号的部分。查了下找到了 <a href="https://github.com/martynsmith/node-irc/issues/205" target="_blank" rel="external">issue #205</a>。原来验证并没有在 IRC RFC 里规定，因此没有包含在库里。嘛好吧，只好自己写了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">nyaa.addListener(<span class="string">"notice"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(from, to, text, message)</span> {</span></div><div class="line">    <span class="comment">// console.log(from + '\n' + to + '\n' + text + '\n' + util.inspect(message, false, null));</span></div><div class="line">    <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'This nickname is registered. Please choose a different nickname, or identify via /msg NickServ identify &lt;password&gt;.'</span>) {</div><div class="line">        nyaa.say(<span class="string">'NickServ'</span>, <span class="string">'identify'</span> + config.password);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'You are now identified for'</span> + config.serveroptions.userName) {</div><div class="line">        console.log(<span class="string">'Login success.'</span>);</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (from === <span class="string">'NickServ'</span></div><div class="line">        && to === config.serveroptions.userName</div><div class="line">        && text === <span class="string">'Invalid password for'</span> + config.serveroptions.userName) {</div><div class="line">        console.log(<span class="string">'Incorrect password. check you config!'</span>);</div><div class="line">    }</div><div class="line">});</div></pre></td></tr></table></figure>

<p>嗯现在就是验证字符串… 所以似乎只能在 freenode 上跑，其他 IRC 服务器是不是这样就不知道了。测试了下表示没问题，收到登陆成功的提示了。</p>
<h3 id="消息处理">消息处理</h3>
<p>目前不准备做私信支持，所以在收到 pm 的时候直接丢一句话过去就可以了。顺便，可以做成自定义消息的说，于是加上了 <code>messages.js</code> 包含所有的可自定义消息。</p>
<p>然后是最重要的功能之一——命令。没命令的 bot 不是好 bot 嗯。编写程序时候的想法是命令以特定字符开头，但是后面如何验证，用 Stackoverflow 上扒来的 <code>startsWith</code> 和 <code>endsWith</code> 函数似乎不能做到足够准确，所以暂且用一个字母加参数来作为命令好了。首先想到的命令功能是搜索 Wiki。毕竟 Minecraft 游戏有够复杂即便是老玩家也不一定能记住 Wiki 里的所有内容。这里想要实现的效果是，提交关键字，返回搜索到的页面链接，并发送该页面的内容总结——也就是 Mediawiki 页面的 section 0。</p>
<p>这里用到了 <code>request</code> 模块，因为 <code>http.get</code> 被弃用且 <code>http.request</code> 说实话用起来比较不爽。<code>request</code> 可以轻松得到页面内容。根据 <a href="http://en.wikipedia.org/w/api.php" target="_blank" rel="external">Mediawiki API</a> 确定使用如下 2 个请求参数：</p>
<ul>
<li><code>/api.php?action=query&amp;format=xml&amp;titles=[页面标题]</code></li>
<li><code>/api.php?format=json&amp;action=parse&amp;prop=text&amp;section=0&amp;page=[页面标题]</code></li>
</ul>
<p>话说我倒是想都用 JSON 的，毕竟 Javascript 原生支持的东西。但是但是第一个 API 返回的 JSON 居然把页面的 pageid 作为 key 啦！你这要我如何是好，为了拿你一个 key/value 要麻烦死了哦。所以还是选择了 XML 并且使用了 <a href="https://github.com/Leonidas-from-XIV/node-xml2js" target="_blank" rel="external">xml2js</a> 这个库。</p>
<p>第二个 API 的数据处理其实一开始也是用的 XML，因为返回的 JSON 里一个 key 是 <code>*</code>，然后我就 <del>很丢脸的</del> 不知所错了… 问了仙子才知道这种带有特殊符号的使用方法是…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    <span class="string">"v"</span>: {</div><div class="line">	      <span class="string">"*"</span>:{</div><div class="line">			<span class="string">"key1"</span>: <span class="string">"value1"</span>,</div><div class="line">			<span class="string">"key2"</span>: <span class="string">"value2"</span></div><div class="line">		  }</div><div class="line">	  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这样的拿到 <code>*</code> 的属性值的方法是 <code>v[&#39;*&#39;]</code> ……… <del>基本功不扎实，实在是太丢脸了 &gt;////&lt;</del></p>
<p>于是拿到了返回文章 summary 的 HTML 代码。先是用正则去掉所有的 HTML Tag 和 <code>\n \r</code> 等换行符，然后发现 HTML 实体没有被转换，于是偷懒用了 <a href="https://www.npmjs.org/package/htmlstrip-native" target="_blank" rel="external">htmlstrip-native</a> 来搞定这个问题。</p>
<p>测试后发现可以正确返回得到页面的链接，但是总结发出来却是乱码。感觉应该是包含了无效的 UTF-8 编码，遂尝试使用正则 <code>/\uFFFD/g</code> 替换掉无效的编码但是不起作用。试图移除最后一个字符也是无用。折腾了大约有 2 个小时，突然发现如果不去掉换行符则消息发出来是正常的。但是不去掉的话一行只有几个字啊… </p>
<p>不过还是有收获，仙子根据不移除换行符则消息正常判断是 IRC 消息长度限制导致了 UTF-8 流被截断。RFC 规定 IRC 消息长度为 512，但是一个 CJK 字符通常占 3 位。所以 512/3 差不多是 170。嘛很不爽的把消息限制改成了 144。这样发出来就不乱码了，但是总结大多比较长要连续发好几条消息导致游戏端被刷屏，玩家颇有微词。</p>
<p>后面就方便多了，加了一条 <code>&#39;p&#39;</code> 命令，意为 <code>play</code> 即 <del>玩坏</del>。在 <code>messages.js</code> 里设定了一个 Object 包含 2 个数组，对应命令消息和响应消息。程序中用 <code>async</code> 来实现命令匹配和回复，以及在没有找到可用命令时发送命令未知消息。还有一条 <code>&#39;c&#39;</code> 用来执行一些真正的命令——比如退出 <em>(:з」∠)</em></p>
<p>嘛现在这 <a href="https://github.com/phoenixlzx/nyaabot" target="_blank" rel="external">bot</a> 已经在群里开始调 (wan) 戏(huai)二小姐了 233</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-06T11:14:34.000Z"><a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/">2014-02-06</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/">Directshare - 一个简单的HTTP直链文件分享工具</a></h1>
  

    </header>
    <div class="entry">
      
        <p>嘛… 最近真心补番补多了智商降得有点厉害.. 直到我发现自己已经看不懂别人的 js 代码，却还会手贱点开 bilibili 之后才 <a href="https://plus.google.com/107142103119739092775/posts/M2LA33yfdRG" target="_blank" rel="external"> 立下军令状</a>，再不开新坑再不敲代码就敲不出来啦！</p>
<p>一直很纠结再写点啥。之前财务管理系统的坑估计要弃，因为实在一个人填不完…然后 NAE 一直没计划好，估计这个坑会更巨。之前 luke 酱说发现了一个不错的东方音乐站，想要个桌面端。咱之前有试着学 Qt 但是一直没有方便的文档而且.. 终归是咱能力不行吧，Qt 估计是一时半会搞不定了。写桌面端的话，似乎只有 node-webkit 了.. 然后看了一下午的文档只有一个感觉——我要死了。</p>
<p><del>Intel 开发的东西和红帽一样蛋疼</del></p>
<p>桌面端什么的…. 所以就放着吧… 随便搞个东西练练手算了。想想看还没有练习过文件上传 <del>真丢人啊都不会写文件上传</del> 于是来写一个上传文件并分享的东西好了 w</p>
<p>于是老样子.. <code>express -e</code> 新建一个项目模板，初始化 git 仓库… 诶似乎有什么东西不对？</p>
<p><code>express.bodyParser()</code> 没了…</p>
<p>先不管这些，基本的路由和功能堆起来，打印出结果来看看能不能正确获取文件信息。然后… 当然失败了。</p>
<p>没有 <code>bodyParser</code> 之后，带有文件上传的表单无法被处理了，<code>req.files</code> 是 <code>undefined</code>，<code>req.body</code> 里也是空的..</p>
<p>一阵 Google 之后表示，泥煤的 express 3.4.x 又改了… <code>bodyParser</code> 已经被 <a href="https://groups.google.com/forum/#!topic/express-js/iP2VyhkypHo" target="_blank" rel="external"> 弃用 </a>，原因是存在<a href="http://andrewkelley.me/post/do-not-use-bodyparser-with-express-js.html" target="_blank" rel="external"> 可能占满磁盘的漏洞</a>。目前推荐的方式是直接使用 <code>multiparty</code>。于是又去翻这货的文档，表示要蛋疼许多… 纠结了一会觉得还是先用回 3.3.4 之后慢慢折腾下 multiparty。</p>
<p>Directshare 使用 HTTP 直链文件，看起来似乎有点危险，不过毕竟可以拿来做图床、临时的文件共享或者在没有 FTP/SSH 的情况下把文件上传到服务器什么的.. 最重要的是，<del>我只是想练练手而已搞那么复杂干嘛..</del></p>
<p>基本思路：整个程序分为负责接收文件的 master 和负责分发文件的 cluster。客户端使用浏览器 POST 方法上传文件 =&gt; master 得到文件后计算 SHA256 并把文件从临时目录移动到保存文件的目录，文件名是 SHA256 值，不带有后缀。接下来通知所有 cluster 来拖。这里要有一个验证，暂且用 POST accesskey 之类的东西来做好了。因为似乎没找到啥能通过 http 同步的 node 包，所以简单的双向 POST 数据基本上也没问题。本来想在 cluster 接收到文件后再计算一次 hash 值.. 不过这个后面再说。通知所有 cluster 用了一个 forEach，虽然是阻塞的方法不过发几个 post 请求应该是相当快的。接下来把从 cluster 下载文件的地址返回给客户端浏览器。这个时候 cluster 应该已经收到 post 请求，过来拖文件了。</p>
<p>文件 <code>master.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</div><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, config.port || <span class="number">3000</span>);</div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(express.favicon());</div><div class="line">app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.bodyParser({</div><div class="line">    keepExtensions: <span class="literal">false</span>,</div><div class="line">    uploadDir: <span class="string">"tmpdata"</span></div><div class="line">}));</div><div class="line">app.use(express.methodOverride());</div><div class="line"><span class="comment">// app.use(app.router);</span></div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.render(<span class="string">'index'</span>, {</div><div class="line">        siteName: config.siteName</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="comment">// console.log(req.files.uploadfile);</span></div><div class="line"></div><div class="line">    <span class="comment">// hash file with sha256</span></div><div class="line">    <span class="keyword">var</span> sha256sum = crypto.createHash(<span class="string">'sha256'</span>);</div><div class="line">    <span class="keyword">var</span> filehash = fs.ReadStream(req.files.uploadfile.path);</div><div class="line">    filehash.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span></div><div class="line">        sha256sum.update(d);</div><div class="line">    });</div><div class="line">    filehash.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">        <span class="keyword">var</span> d = sha256sum.digest(<span class="string">'hex'</span>);</div><div class="line">        console.log(d + <span class="string">''</span> + req.files.uploadfile.name);</div><div class="line">        <span class="comment">// move file to storage location</span></div><div class="line">        fs.rename(req.files.uploadfile.path, <span class="string">'files/'</span> + d, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">            <span class="comment">// notify clusters to fetch file</span></div><div class="line">            config.clusters.forEach(<span class="function"><span class="keyword">function</span><span class="params">(cluster)</span> {</span></div><div class="line">                <span class="keyword">var</span> post_data = querystring.stringify({</div><div class="line">                    clusterkey: config.clusterkey,</div><div class="line">                    filename: req.files.uploadfile.name,</div><div class="line">                    filehash: d</div><div class="line">                });</div><div class="line"></div><div class="line">                <span class="keyword">var</span> post_options = {</div><div class="line">                    hostname: cluster,</div><div class="line">                    port: config.clustersport,</div><div class="line">                    path: <span class="string">'/syncfile'</span>,</div><div class="line">                    method: <span class="string">'POST'</span>,</div><div class="line">                    headers: {</div><div class="line">                        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</div><div class="line">                        <span class="string">'Content-Length'</span>: post_data.length</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// Set up the request</span></div><div class="line">                console.log(<span class="string">'syncing with '</span> + cluster);</div><div class="line">                <span class="keyword">var</span> post_req = http.request(post_options);</div><div class="line"></div><div class="line">                <span class="comment">// post the data</span></div><div class="line">                post_req.write(post_data);</div><div class="line">                post_req.end();</div><div class="line">            });</div><div class="line">            <span class="comment">// return client with download path</span></div><div class="line">            res.send(<span class="number">200</span>, config.clusterurl + d);</div><div class="line">        });</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/syncfile'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) {</div><div class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        res.sendfile(<span class="string">'files/'</span> + req.body.filehash);</div><div class="line">    }</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// handle 404</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.send(<span class="number">404</span>, <span class="string">'My files gone?! :-O'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port '</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p>然后是 <code>cluster.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// all environments</span></div><div class="line">app.set(<span class="string">'port'</span>, config.port || <span class="number">3000</span>);</div><div class="line">app.use(express.favicon());app.use(express.logger(<span class="string">'dev'</span>));</div><div class="line">app.use(express.json());</div><div class="line">app.use(express.methodOverride());</div><div class="line">app.use(express.bodyParser());</div><div class="line">app.use(app.router);</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line"><span class="comment">// development only</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'development'</span> == app.get(<span class="string">'env'</span>)) {</div><div class="line">  app.use(express.errorHandler());</div><div class="line">}</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    res.send(<span class="number">400</span>, <span class="string">'Bad request'</span>);</div><div class="line">});</div><div class="line"></div><div class="line">app.get(<span class="string">'/:hash'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    fs.readFile(<span class="string">'files/'</span> + req.params.hash + <span class="string">'.json'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, filedata)</span> {</span></div><div class="line">        <span class="keyword">if</span> (err) {</div><div class="line">            <span class="keyword">if</span> (err.code === <span class="string">'ENOENT'</span>) {</div><div class="line">                res.send(<span class="number">404</span>, <span class="string">'File not found. :-('</span>);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                console.log(err);</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="keyword">var</span> filedata = <span class="built_in">JSON</span>.parse(filedata);</div><div class="line">            res.download(<span class="string">'files/'</span> + req.params.hash, filedata.filename);</div><div class="line">        }</div><div class="line">    })</div><div class="line">});</div><div class="line"></div><div class="line">app.post(<span class="string">'/syncfile'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span></div><div class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) {</div><div class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        res.send(<span class="number">200</span>);</div><div class="line">        <span class="keyword">var</span> post_data = querystring.stringify({</div><div class="line">            clusterkey: config.clusterkey,</div><div class="line">            filehash: req.body.filehash</div><div class="line">        });</div><div class="line"></div><div class="line">        <span class="keyword">var</span> post_options = {</div><div class="line">            hostname: config.master,</div><div class="line">            port: config.masterport,</div><div class="line">            path: <span class="string">'/syncfile'</span>,</div><div class="line">            method: <span class="string">'POST'</span>,</div><div class="line">            headers: {</div><div class="line">                <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</div><div class="line">                <span class="string">'Content-Length'</span>: post_data.length</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Set up the request</span></div><div class="line">        console.log(<span class="string">'Getting file with SHA256'</span> + req.body.filehash);</div><div class="line">        <span class="keyword">var</span> post_req = http.request(post_options, <span class="function"><span class="keyword">function</span><span class="params">(res)</span> {</span></div><div class="line">            <span class="keyword">var</span> file = fs.createWriteStream(<span class="string">'files/'</span> + req.body.filehash);</div><div class="line">            res.pipe(file);</div><div class="line">        });</div><div class="line"></div><div class="line">        <span class="comment">// post the data</span></div><div class="line">        post_req.write(post_data);</div><div class="line">        post_req.end();</div><div class="line"></div><div class="line">        fs.appendFile(<span class="string">'files/'</span> + req.body.filehash + <span class="string">'.json'</span>, <span class="built_in">JSON</span>.stringify({</div><div class="line">            <span class="string">"filename"</span>: req.body.filename</div><div class="line">        }), <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></div><div class="line">            console.log(<span class="string">'Saved file'</span> + req.body.filename + <span class="string">'with hash'</span> + req.body.filehash);</div><div class="line">        });</div><div class="line">    }</div><div class="line"></div><div class="line">});</div><div class="line"></div><div class="line">http.createServer(app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></div><div class="line">  console.log(<span class="string">'Express server listening on port'</span> + app.get(<span class="string">'port'</span>));</div><div class="line">});</div></pre></td></tr></table></figure>

<p>这样程序应该就相当清晰了。在 cluster 端使用了 SHA256 值作为文件名的 json 作为文件信息存储，当前只保存了对应的文件名。至于重复文件啊什么的.. 暂时没想好怎么做，不过拿 sha256 做文件名本来就有这个功能的想法。本地测试完成，commit #<a href="https://github.com/phoenixlzx/directshare/commit/f6365cfcbd18536f226da1e4fe633ece665b6ec2" target="_blank" rel="external"><code>f6365cfcbd</code></a></p>
<p>当我发军令状的时候是昨晚 9 点，第一个可用版本提交是今天 2 点左右，5 个小时开新坑再填上… 不过这坑有点小所以好填… 所以 5 个小时不算什么了吧就… 嘛至少不用改名 BAKA 了～</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:blog.phoenixlzx.com">
  </form>
</div>

  <div class="widget tag">
    <h3 class="title">关于</h3>
    <div class="entry">
        <img src="/static/img/avatar/avatar.jpg" style="margin: auto; width: 100%;"/>
        <h4 style="text-align: center">Phoenix Nemo (phoenixlzx)</h4>
        <div style="margin: auto; text-align: center;">
            <a href="https://plus.google.com/107142103119739092775" target="_blank"><i class="fa fa-google-plus fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://twitter.com/phoenixlzx" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>&nbsp;&nbsp;
            <a href="https://github.com/phoenixlzx" target="_blank"><i class="fa fa-github fa-2x"></i></a>&nbsp;&nbsp;
            <a class="fancybox" href="#emailme"><i class="fa fa-envelope-o fa-2x"></i></a>
        </div>
        <div style="display: none;">
            <div id="emailme">
                <p><strong>个人邮箱地址</strong></p>
                <br/>
                <code>echo 'aUBwaG9lbml4bHp4LmNvbQo='|base64 --decode</code>
            </div>
        </div>
    </div>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Algorithm/">Algorithm</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>4</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>2</small></li>
  
    <li><a href="/categories/Network/">Network</a><small>3</small></li>
  
    <li><a href="/categories/Nodejs/">Node.js</a><small>5</small></li>
  
    <li><a href="/categories/Notes/">Notes</a><small>8</small></li>
  
    <li><a href="/categories/Practise/">Practise</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Algorithm/" style="font-size: 10.00px;">Algorithm</a><a href="/tags/Anime/" style="font-size: 16.00px;">Anime</a><a href="/tags/Artwork/" style="font-size: 10.00px;">Artwork</a><a href="/tags/Configuration/" style="font-size: 12.00px;">Configuration</a><a href="/tags/DKMS/" style="font-size: 10.00px;">DKMS</a><a href="/tags/DNS/" style="font-size: 14.00px;">DNS</a><a href="/tags/FFmpeg/" style="font-size: 14.00px;">FFmpeg</a><a href="/tags/Fibonacci/" style="font-size: 10.00px;">Fibonacci</a><a href="/tags/Filesystem/" style="font-size: 10.00px;">Filesystem</a><a href="/tags/ImageMagick/" style="font-size: 10.00px;">ImageMagick</a><a href="/tags/KDE/" style="font-size: 10.00px;">KDE</a><a href="/tags/Kernel/" style="font-size: 10.00px;">Kernel</a><a href="/tags/Linux/" style="font-size: 14.00px;">Linux</a><a href="/tags/Minecraft/" style="font-size: 12.00px;">Minecraft</a><a href="/tags/MongoDB/" style="font-size: 10.00px;">MongoDB</a><a href="/tags/Multimedia/" style="font-size: 14.00px;">Multimedia</a><a href="/tags/MyPet/" style="font-size: 10.00px;">MyPet</a><a href="/tags/Network/" style="font-size: 14.00px;">Network</a><a href="/tags/Nodejs/" style="font-size: 20.00px;">Node.js</a><a href="/tags/Practise/" style="font-size: 10.00px;">Practise</a><a href="/tags/Script/" style="font-size: 10.00px;">Script</a><a href="/tags/Server/" style="font-size: 18.00px;">Server</a><a href="/tags/Ubuntu/" style="font-size: 14.00px;">Ubuntu</a><a href="/tags/VPN/" style="font-size: 10.00px;">VPN</a><a href="/tags/WordPress/" style="font-size: 10.00px;">WordPress</a><a href="/tags/iptables/" style="font-size: 12.00px;">iptables</a>
  </div>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2014/07/21/setup-openconnect-server-on-ubuntu/">在 Ubuntu 服务器上搭建 OpenConnect 服务器小记</a>
      </li>
    
      <li>
        <a href="/2014/05/24/iptables-rate-limiting-rules-to-block-dns-amplification-attack/">使用 iptables 过滤 DNS 放大攻击</a>
      </li>
    
      <li>
        <a href="/2014/05/19/for-loop-in-async-function-with-async-in-it/">在异步方法中使用 for 循环，以及循环中包含异步方法的几点坑</a>
      </li>
    
      <li>
        <a href="/2014/05/17/repo-arm-disk-rescue-and-resize/">修复 Arch Rollback Machine 磁盘占用</a>
      </li>
    
      <li>
        <a href="/2014/05/16/accelerate-apple-services-in-cn/">为国内用户加速 Apple 服务</a>
      </li>
    
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Phoenix Nemo
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'phoenixhexo';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js?https';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>